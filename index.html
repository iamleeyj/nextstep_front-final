<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextStep - AI 주식 분석</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        /* Google Fonts Import */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Page transition effect */
        .page-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active state for buttons */
        .btn-active:active { transform: scale(0.97); transition: transform 0.1s; }
        .chart-container { position: relative; min-height: 450px; width: 100%; }
        .stock-row { cursor: pointer; }
        
        /* Draggable widget styles */
        .widget.dragging { opacity: 0.5; border: 2px dashed #3b82f6; }
        .widget.drag-over { transform: scale(1.02); }

        /* Tooltip for AI explanation */
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text { visibility: hidden; width: 250px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 51; bottom: 135%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 13px; font-weight: normal; line-height: 1.6; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Guidebook Styles */
        #guidebook-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            transition: opacity 0.3s ease;
        }
        .guidebook-highlight {
            position: relative;
            z-index: 1000;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            border-radius: 6px;
            transition: all 0.3s ease-in-out;
        }
        #guidebook-modal {
            position: fixed;
            z-index: 1001;
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease-out;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-300">

    <div id="app" class="flex flex-col min-h-screen"></div>
    
    <div id="modal-container"></div>
    <div id="guidebook-container"></div>

    <script type="module">
        // ===================================================================================
        // MOCK DATA (백엔드 API 모의 데이터)
        // ===================================================================================
        const mockApi = {
            login: (username, password) => {
                if (username === 'test' && password === 'test1234') {
                    return Promise.resolve({ accessToken: 'mock-jwt-token-string', user: { email: 'test@nextstep.com', username: 'test' } });
                }
                const users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                const user = users.find(u => u.username === username && u.password === password);
                if (user) return Promise.resolve({ accessToken: `mock-jwt-for-${user.username}`, user });
                return Promise.reject({ message: '아이디 또는 비밀번호가 올바르지 않습니다.' });
            },
            signup: (email, username, password) => {
                let users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                if (users.some(u => u.username === username)) return Promise.reject({ message: '이미 사용 중인 아이디입니다.' });
                if (users.some(u => u.email === email)) return Promise.reject({ message: '이미 사용 중인 이메일입니다.' });
                const newUser = { email, username, password };
                users.push(newUser);
                localStorage.setItem('nextstep-users', JSON.stringify(users));
                return Promise.resolve({ message: '회원가입 성공!' });
            },
            updateUser: (username, newPassword) => {
                let users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex > -1) {
                    users[userIndex].password = newPassword;
                    localStorage.setItem('nextstep-users', JSON.stringify(users));
                    return Promise.resolve({ message: '비밀번호가 변경되었습니다.' });
                }
                return Promise.reject({ message: '사용자를 찾을 수 없습니다.' });
            },
            deleteUser: (username) => {
                let users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                users = users.filter(u => u.username !== username);
                localStorage.setItem('nextstep-users', JSON.stringify(users));
                return Promise.resolve({ message: '회원 탈퇴가 완료되었습니다.' });
            },
            getKospiStocks: () => Promise.resolve([
                { code: '005930', name: '삼성전자', price: 82000, change: 1200, changeRate: 1.49, volume: 18000000 },
                { code: '000660', name: 'SK하이닉스', price: 230000, change: -2500, changeRate: -1.08, volume: 9500000 },
                { code: '035420', name: 'NAVER', price: 195000, change: 500, changeRate: 0.26, volume: 1500000 },
                { code: '035720', name: '카카오', price: 48000, change: -800, changeRate: -1.64, volume: 6000000 },
                { code: '207940', name: '삼성바이오로직스', price: 750000, change: 10000, changeRate: 1.35, volume: 400000 },
                { code: '005380', name: '현대차', price: 280000, change: 3000, changeRate: 1.08, volume: 1100000 },
                { code: '005490', name: 'POSCO홀딩스', price: 380000, change: -5000, changeRate: -1.30, volume: 850000 },
                { code: '051910', name: 'LG화학', price: 420000, change: 7000, changeRate: 1.69, volume: 700000 },
            ]),
            getStockChartData: (stockCode) => {
                const today = new Date();
                const historicalData = [];
                const predictionData = [];
                let lastClose = stockCode === 'TUTORIAL-01' ? 50000 : Math.random() * 100000 + 50000;

                for (let i = 365 * 2; i > 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    if (date.getDay() === 0 || date.getDay() === 6) continue;
                    const open = lastClose * (1 + (Math.random() - 0.5) * 0.05);
                    const high = Math.max(open, lastClose) * (1 + Math.random() * 0.03);
                    const low = Math.min(open, lastClose) * (1 - Math.random() * 0.03);
                    const close = low + Math.random() * (high - low);
                    historicalData.push({ x: date.getTime(), y: [open, high, low, close] });
                    lastClose = close;
                }
                
                let lastPrediction = historicalData.length > 0 ? historicalData[historicalData.length - 1].y[3] : lastClose;
                for (let i = 1; i <= 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);
                    const prediction = lastPrediction * (1 + (Math.random() - 0.45) * 0.03);
                    predictionData.push({ time: date.getTime(), value: prediction });
                    lastPrediction = prediction;
                }
                return Promise.resolve({ historicalData, predictionData });
            },
            getIndices: () => Promise.resolve({
                kospi: { value: 2810.55, change: 15.12, changeRate: 0.54 },
                gold: { price1kg: 108500000, price100g: 10900000 },
                oil: { gasoline: 1720, diesel: 1650, kerosene: 1180 },
            }),
            getAiRecommendations: () => Promise.resolve([
                { code: '000660', name: 'SK하이닉스', signal: '매수', confidence: 0.85, targetPrice: 250000 },
                { code: '035720', name: '카카오', signal: '보유', confidence: 0.65, targetPrice: 52000 },
                { code: '005490', name: 'POSCO홀딩스', signal: '매도', confidence: 0.78, targetPrice: 360000 },
            ]),
            getNews: () => Promise.resolve([
                { id: 1, url: '#', title: "삼성전자, 차세대 AI 칩 '마하-2' 공개 임박...", source: "전자신문", time: "2시간 전", summary: "삼성전자가 자체 개발한 AI 칩 '마하-2'를 공개하며 엔비디아의 아성에 도전합니다. 업계의 판도를 바꿀 수 있을지 귀추가 주목됩니다.", sentiment: "positive" },
                { id: 2, url: '#', title: "현대차, 미국 전기차 시장 점유율 15% 돌파 쾌거", source: "연합뉴스", time: "5시간 전", summary: "현대자동차가 아이오닉 시리즈의 꾸준한 인기에 힘입어 미국 전기차 시장에서 15%의 점유율을 기록하며 테슬라를 맹추격하고 있습니다.", sentiment: "positive" },
            ]),
            getKospiHistory: (days) => {
                const data = []; let lastValue = 2810; const today = new Date();
                for(let i=days; i>0; i--){
                    const date = new Date(today); date.setDate(today.getDate() - i);
                    if (date.getDay() === 0 || date.getDay() === 6) continue;
                    lastValue *= (1 + (Math.random() - 0.48) * 0.015);
                    data.push({x: date.getTime(), y: lastValue});
                }
                return Promise.resolve(data);
            },
        };

        // ===================================================================================
        // APPLICATION STATE & UTILITIES
        // ===================================================================================
        const state = {
            isLoggedIn: !!localStorage.getItem('nextstep-token'),
            currentUser: JSON.parse(localStorage.getItem('nextstep-user')),
            currentPage: 'home',
            currentParams: null,
            kospiStocks: [],
            favorites: JSON.parse(localStorage.getItem('nextstep-favorites')) || ['005930', '035420'],
            widgets: JSON.parse(localStorage.getItem('nextstep-widgets')) || [
                { id: 'indices', type: 'indices' }, { id: 'kospiChart', type: 'kospiChart' },
                { id: 'topVolume', type: 'topVolume' }, { id: 'favorites', type: 'favorites' },
                { id: 'goldPrice', type: 'goldPrice' }, { id: 'oilPrice', type: 'oilPrice' },
            ],
            isWidgetEditMode: false,
            domesticSort: { key: 'volume', order: 'desc' },
            charts: {},
            draggedWidgetId: null,
            detailChartType: 'candlestick',
            aiChartType: 'candlestick',
            guidebookStep: 0,
            isGuidebookActive: false,
        };

        function formatKoreanDate(timestamp, format = 'long') {
            const options = { year: 'numeric', month: format, day: 'numeric' };
            return new Date(timestamp).toLocaleDateString('ko-KR', options);
        }
        
        // SVG Icons
        const svgIcons = {
            starFilled: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-yellow-400"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clip-rule="evenodd" /></svg>`,
            starOutline: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>`,
            sortAsc: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1"><path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.612L6.22 8.64a.75.75 0 11-1.06-1.06l4.25-4.25a.75.75 0 011.06 0l4.25 4.25a.75.75 0 11-1.06 1.06L10.75 5.612V16.25A.75.75 0 0110 17z" clip-rule="evenodd" /></svg>`,
            sortDesc: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.638l3.03-3.03a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L6.22 12.47a.75.75 0 111.06-1.06l3.03 3.03V3.75A.75.75 0 0110 3z" clip-rule="evenodd" /></svg>`,
        };
        
        // ===================================================================================
        // RENDER FUNCTIONS
        // ===================================================================================
        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        const guidebookContainer = document.getElementById('guidebook-container');
        
        function renderApp() {
            if (!state.isLoggedIn) {
                renderLoginPage();
                return;
            }
            appContainer.innerHTML = `
                <header id="app-header" class="bg-white shadow-md sticky top-0 z-40 transition-colors duration-300"></header>
                <main id="app-main" class="flex-grow container mx-auto p-4 md:p-6"></main>`;
            renderPage();
            
            if (localStorage.getItem('nextstep-hide-guidebook') !== 'true' && !sessionStorage.getItem('guidebook-shown')) {
                startGuidebook();
                sessionStorage.setItem('guidebook-shown', 'true');
            }
        }

        function renderHeader() {
            const header = document.getElementById('app-header');
            if (!header) return;
            const navLinks = [
                { id: 'home', text: '홈' }, { id: 'domestic', text: '국내' }, { id: 'news', text: '뉴스' },
                { id: 'market', text: '시장' }, { id: 'ai', text: 'AI 분석' }, { id: 'mock', text: '모의투자' }, { id: 'my', text: 'MY' }
            ];
            const navItems = navLinks.map(link => `<a href="#" data-page="${link.id}" class="nav-link px-4 py-2 rounded-md text-sm font-medium transition-colors ${state.currentPage === link.id ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">${link.text}</a>`).join('');
            header.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <a href="#" data-page="home" class="flex-shrink-0 flex items-center">
                                <img src="logo.png" alt="NextStep Logo" class="h-10 w-auto">
                            </a>
                        </div>
                        <nav class="hidden md:flex flex-grow justify-center space-x-2">${navItems}</nav>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-gray-700"><strong>${state.currentUser.username}</strong>님</span>
                            <button id="logout-btn" class="text-sm font-medium text-gray-500 hover:text-blue-600 btn-active">로그아웃</button>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderPage() {
            Object.values(state.charts).forEach(chart => chart?.destroy());
            state.charts = {};
            const main = document.getElementById('app-main');
            if (!main) return;
            main.innerHTML = '<div class="page-content"></div>';
            const pageContent = main.querySelector('.page-content');
            
            switch (state.currentPage) {
                case 'home': renderHomePage(pageContent); break;
                case 'domestic': renderDomesticPage(pageContent); break;
                case 'news': renderNewsPage(pageContent); break;
                case 'market': renderMarketPage(pageContent); break;
                case 'ai': renderAiAnalysisPage(pageContent); break;
                case 'mock': renderMockInvestmentPage(pageContent); break;
                case 'my': renderMyPage(pageContent); break;
                default: renderHomePage(pageContent);
            }
            renderHeader();
        }

        // --- Auth & Modal Pages ---
        function renderLoginPage(error = null) {
            appContainer.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-gray-100">
                <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                    <a href="#" onclick="window.location.reload()"><img src="logo.png" alt="Logo" class="w-48 mx-auto mb-6"></a>
                    <form id="login-form">
                        ${error ? `<p class="text-red-500 text-sm mb-4 text-center">${error}</p>` : ''}
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium mb-1 text-gray-700">아이디</label>
                            <input type="text" id="username" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="test">
                        </div>
                        <div class="mb-6"><label for="password" class="block text-sm font-medium mb-1 text-gray-700">비밀번호</label><input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="test1234"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">로그인</button>
                        <p class="text-center mt-4 text-sm text-gray-600">계정이 없으신가요? <a href="#" id="go-to-signup" class="text-blue-500 hover:underline">회원가입</a></p>
                    </form>
                </div>
            </div>`;
        }

        function renderSignupPage(error = null) {
            appContainer.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-gray-100">
                <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">회원가입</h2>
                    ${error ? `<p class="text-red-500 text-sm mb-4 text-center">${error}</p>` : ''}
                    <form id="signup-form">
                        <div class="mb-4"><label for="email" class="block text-sm font-medium mb-1 text-gray-700">이메일</label><input type="email" id="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <div class="mb-4"><label for="username" class="block text-sm font-medium mb-1 text-gray-700">아이디</label><input type="text" id="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <div class="mb-6"><label for="password" class="block text-sm font-medium mb-1 text-gray-700">비밀번호</label><input type="password" id="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">가입하기</button>
                        <p class="text-center mt-4 text-sm text-gray-600">이미 계정이 있으신가요? <a href="#" id="go-to-login" class="text-blue-500 hover:underline">로그인</a></p>
                    </form>
                </div>
            </div>`;
        }

        // --- Home Page ---
        async function renderHomePage(container) {
            const editButtonText = state.isWidgetEditMode ? '완료' : '위젯 편집';
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold">홈</h1>
                    <button id="widget-edit-toggle" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg btn-active">${editButtonText}</button>
                </div>
                ${state.isWidgetEditMode ? `<p id="widget-drag-guide" class="text-center text-sm text-gray-500 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200">✨ 위젯을 드래그하여 순서를 변경해보세요.</p>`: ''}
                <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 auto-rows-fr"></div>
                ${state.isWidgetEditMode ? renderAddWidgetPanel() : ''}`;
            renderWidgets();
        }
        
        function renderAddWidgetPanel() {
            const allWidgetTypes = [
                { type: 'indices', name: '핵심 지표' }, { type: 'kospiChart', name: 'KOSPI 차트' },
                { type: 'topVolume', name: '주요 종목' }, { type: 'favorites', name: '내 즐겨찾기' },
                { type: 'goldPrice', name: '금 시세' }, { type: 'oilPrice', name: '유가 정보' }
            ];
            const widgetButtons = allWidgetTypes.map(w => {
                const isAdded = state.widgets.some(sw => sw.type === w.type);
                return `<button data-widget-type="${w.type}" class="add-widget-btn text-left p-3 rounded-lg ${isAdded ? 'bg-gray-200 cursor-not-allowed text-gray-500' : 'bg-gray-100 hover:bg-blue-100'}" ${isAdded ? 'disabled' : ''}><p class="font-semibold">${w.name}</p></button>`;
            }).join('');
            return `<div id="add-widget-panel" class="mt-8 bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-bold mb-4">위젯 추가하기</h3><div class="grid grid-cols-2 sm:grid-cols-4 gap-4">${widgetButtons}</div></div>`;
        }

        async function renderWidgets() {
            const grid = document.getElementById('widget-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const indicesData = await mockApi.getIndices();
            
            for (const widgetConfig of state.widgets) {
                const widgetEl = document.createElement('div');
                widgetEl.id = widgetConfig.id;
                widgetEl.dataset.widgetType = widgetConfig.type;
                widgetEl.className = 'widget bg-white p-6 rounded-lg shadow-md relative transition-transform flex flex-col';
                if(state.isWidgetEditMode) {
                    widgetEl.draggable = true;
                    widgetEl.classList.add('cursor-move');
                }

                let content = '';
                if (state.isWidgetEditMode) content += `<button data-widget-id="${widgetConfig.id}" class="remove-widget-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-xs z-10">&times;</button>`;
                
                let isClickable = false;
                switch (widgetConfig.type) {
                    case 'indices': content += renderIndicesWidget(indicesData); break;
                    case 'kospiChart': widgetEl.classList.add('md:col-span-2', 'xl:col-span-2'); content += renderKospiChartWidget(); break;
                    case 'topVolume': isClickable = true; content += renderTopVolumeWidget(); break;
                    case 'favorites': isClickable = true; content += await renderFavoritesWidget(); break;
                    case 'goldPrice': content += renderGoldWidget(indicesData); break;
                    case 'oilPrice': content += renderOilWidget(indicesData); break;
                }
                widgetEl.innerHTML = content;
                if(isClickable && !state.isWidgetEditMode) {
                    widgetEl.querySelectorAll('li[data-stock-code]').forEach(li => li.classList.add('cursor-pointer', 'hover:bg-gray-100', 'p-1', 'rounded'));
                }
                grid.appendChild(widgetEl);

                if(widgetConfig.type === 'kospiChart') updateKospiChart(7);
            }
        }
        
        function renderIndicesWidget(data) { return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">핵심 경제 지표</h3><div class="space-y-3 flex-grow flex flex-col justify-center"><div class="flex justify-between items-center"><span class="font-medium text-gray-700">KOSPI</span><div>${data.kospi.value.toFixed(2)} <span class="${data.kospi.change > 0 ? 'text-red-500':'text-blue-500'}">${data.kospi.change > 0 ? '▲' : '▼'} ${Math.abs(data.kospi.change).toFixed(2)}</span></div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">금 (1kg)</span><div>${data.gold.price1kg.toLocaleString()}원</div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">휘발유</span><div>${data.oil.gasoline.toLocaleString()}원</div></div></div>`; }
        function renderGoldWidget(data) { return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">금 시세</h3><div class="space-y-3 flex-grow flex flex-col justify-center"><div class="flex justify-between items-center"><span class="font-medium text-gray-700">1kg</span><div>${data.gold.price1kg.toLocaleString()} 원</div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">100g</span><div>${data.gold.price100g.toLocaleString()} 원</div></div></div>`; }
        function renderOilWidget(data) { return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">유가 정보</h3><div class="space-y-3 flex-grow flex flex-col justify-center"><div class="flex justify-between items-center"><span class="font-medium text-gray-700">휘발유</span><div>${data.oil.gasoline.toLocaleString()} 원</div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">경유</span><div>${data.oil.diesel.toLocaleString()} 원</div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">등유</span><div>${data.oil.kerosene.toLocaleString()} 원</div></div></div>`; }
        function renderKospiChartWidget(){ return `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">KOSPI 지수</h3><div class="flex space-x-1 text-xs"><button data-days="7" class="kospi-chart-period-btn px-2 py-1 rounded bg-blue-600 text-white">1주</button><button data-days="30" class="kospi-chart-period-btn px-2 py-1 rounded bg-gray-200">1달</button><button data-days="365" class="kospi-chart-period-btn px-2 py-1 rounded bg-gray-200">1년</button></div></div><div class="h-48 flex-grow" id="home-kospi-chart"></div>`; }
        function renderTopVolumeWidget() { const stocks = [...state.kospiStocks].sort((a,b)=>b.volume-a.volume).slice(0,5); return `<h3 id="top-volume-widget-title" class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">거래량 상위</h3><ul id="top-volume-list" class="space-y-2">${stocks.map(s => `<li data-stock-code="${s.code}"><div class="flex justify-between text-sm items-center"><span class="font-medium text-gray-800">${s.name}</span><span class="${s.change > 0 ? 'text-red-500' : 'text-blue-500'}">${s.change > 0 ? '+' : ''}${s.changeRate.toFixed(2)}%</span></div></li>`).join('')}</ul>`; }
        async function renderFavoritesWidget() { const stocks = state.kospiStocks.filter(s => state.favorites.includes(s.code)); return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">내 즐겨찾기</h3><ul class="divide-y">${stocks.length ? stocks.map(s => `<li data-stock-code="${s.code}" class="py-2"><div class="flex justify-between items-center"><span class="font-medium text-gray-800">${s.name}</span><span class="${s.change > 0 ? 'text-red-500' : 'text-blue-500'}">${s.price.toLocaleString()}</span></div></li>`).join('') : '<li class="text-center text-gray-500 py-4">즐겨찾는 종목이 없습니다.</li>'}</ul>`; }
        
        // --- Domestic Page & Modal ---
        function renderDomesticPage(container) { container.innerHTML = `<h1 class="text-2xl font-bold mb-1">국내</h1><p class="text-gray-500 mb-6">KOSPI 종목의 현재 시세를 확인하고, 상세 차트를 분석해보세요.</p><div class="mb-4"><input type="text" id="stock-search" placeholder="종목명 또는 코드를 검색하세요..." class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="p-4 w-12"></th><th class="p-4 font-semibold cursor-pointer sortable-header flex items-center" data-sort-key="name">종목명</th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="price">현재가</th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="changeRate">등락률</th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="volume">거래량</th></tr></thead><tbody id="stock-list-body"></tbody></table></div>`; renderStockList(state.kospiStocks); }
        function renderStockList(stocks) {
            const listBody=document.getElementById('stock-list-body'); if(!listBody)return;
            const sortedStocks=[...stocks].sort((a,b)=>{const{key,order}=state.domesticSort;if(a[key]<b[key])return order==='asc'?-1:1;if(a[key]>b[key])return order==='asc'?1:-1;return 0});
            document.querySelectorAll('.sortable-header').forEach(h=>{
                const currentText = h.innerText.trim();
                h.innerHTML = `${currentText.replace(/ [▲▼]$/,'')} <span class="sort-icon-container"></span>`;
                if(h.dataset.sortKey===state.domesticSort.key) {
                    h.querySelector('.sort-icon-container').innerHTML = state.domesticSort.order === 'asc' ? svgIcons.sortAsc : svgIcons.sortDesc;
                }
            });
            if(sortedStocks.length===0){listBody.innerHTML='<tr><td colspan="5" class="text-center p-8 text-gray-500">검색 결과가 없습니다.</td></tr>';return}
            listBody.innerHTML=sortedStocks.map(s=>{const isFavorite=state.isLoggedIn&&state.favorites.includes(s.code);const color=s.change>0?'text-red-500':s.change<0?'text-blue-500':'text-gray-500';const sign=s.change>0?'+':'';return`<tr class="stock-row hover:bg-gray-100 border-b last:border-b-0" data-stock-code="${s.code}"><td class="p-4"><button class="toggle-favorite-btn" data-stock-code="${s.code}">${isFavorite ? svgIcons.starFilled : svgIcons.starOutline}</button></td><td class="p-4 font-medium"><div class="text-gray-900">${s.name}</div><div class="text-sm text-gray-400">${s.code}</div></td><td class="p-4 text-right font-semibold ${color}">${s.price.toLocaleString()}</td><td class="p-4 text-right ${color}">${sign}${s.changeRate.toFixed(2)}%</td><td class="p-4 text-right text-sm text-gray-600">${s.volume.toLocaleString()}</td></tr>`}).join('')
        }

        async function renderStockDetailModal(stockCode) {
            const stock = state.kospiStocks.find(s => s.code === stockCode);
            if (!stock) return;
            const modalHTML = `
            <div id="stock-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-2xl p-6 max-w-4xl w-full transform transition-all scale-95 opacity-0">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                        <h2 class="text-xl font-bold">${stock.name} (${stock.code})</h2>
                        <button id="close-detail-modal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="flex justify-end items-center mb-2 space-x-2 text-xs">
                        <button class="detail-chart-type-btn px-3 py-1 rounded-full" data-type="candlestick">캔들차트</button>
                        <button class="detail-chart-type-btn px-3 py-1 rounded-full" data-type="line">선차트</button>
                    </div>
                    <div id="detail-chart-container" class="h-80 mb-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                        <div>
                            <h3 class="font-semibold mb-2 text-sm">AI 1주일 예측 (종가)</h3>
                            <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-2">날짜</th><th class="p-2 text-right">예상 종가</th></tr></thead><tbody id="prediction-table"></tbody></table>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="mb-3 text-gray-700">더 상세한 AI 분석과 기술적 지표를 확인해보세요.</p>
                            <button id="go-to-ai-page-from-modal" data-stock-code="${stockCode}" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">AI 분석 바로가기</button>
                        </div>
                    </div>
                </div>
            </div>`;
            modalContainer.innerHTML = modalHTML;
            const modalContent = modalContainer.querySelector('#stock-detail-modal > div');
            setTimeout(() => { modalContent.style.transform = 'scale(1)'; modalContent.style.opacity = '1'; }, 50);

            const { historicalData, predictionData } = await mockApi.getStockChartData(stockCode);
            renderDetailChart(historicalData, stockCode);
            document.getElementById('prediction-table').innerHTML = predictionData.map(d => `<tr><td class="p-2">${formatKoreanDate(d.time)}</td><td class="p-2 text-right">${Math.round(d.value).toLocaleString()}원</td></tr>`).join('');
        }

        // --- Other Pages ---
        async function renderAiAnalysisPage(container) {    
            const selectedCode = state.currentParams?.stockCode;
            const favoriteStocks = state.kospiStocks.filter(s => state.favorites.includes(s.code));
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">AI 분석</h1>
            <p class="text-gray-500 mb-6">NextStep의 AI가 예측한 미래 주가를 통해 투자 인사이트를 얻어보세요.</p>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <label for="ai-stock-search" class="block text-sm font-medium mb-2">분석할 종목 검색:</label>
                        <input type="search" id="ai-stock-search" placeholder="종목명 또는 코드를 검색하세요..." class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="ai-search-results" class="mt-2 max-h-48 overflow-y-auto"></div>
                        ${favoriteStocks.length > 0 ? `
                        <div class="mt-4 pt-3 border-t">
                            <h4 class="text-sm font-semibold mb-2 text-gray-600">즐겨찾기 목록:</h4>
                            <div id="ai-favorites-list" class="flex flex-wrap gap-2">
                                ${favoriteStocks.map(s => `<button class="ai-quick-select-btn text-xs px-3 py-1 rounded-full bg-gray-200 hover:bg-blue-200" data-stock-code="${s.code}">${s.name}</button>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                    <div id="ai-chart-area" class="bg-white p-6 rounded-lg shadow-md min-h-[500px]">
                        ${!selectedCode ? `<div class="flex items-center justify-center h-full text-gray-500">분석할 종목을 검색하거나 선택해주세요.</div>` : ''}
                    </div>
                </div>
                <div id="ai-recommendations-panel" class="bg-white p-6 rounded-lg shadow-md h-fit"></div>
            </div>`;
            if(selectedCode){
                updateAiChart(selectedCode);
            }    
            renderAiRecommendations();
        }
        
        async function renderAiRecommendations() {    
            const panel=document.getElementById('ai-recommendations-panel');
            if(!panel) return;
            const recommendations=await mockApi.getAiRecommendations();
            panel.innerHTML=`
            <h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2 flex items-center">AI 매매 신호    
                <div class="tooltip-container ml-2">
                    <span class="cursor-pointer text-blue-500">ⓘ</span>
                    <span class="tooltip-text">GRU(Gated Recurrent Unit) AI 모델이 과거 2년치 주가 패턴을 학습하여 향후 1주일간의 상승/하락 추세를 예측합니다. '매수'는 상승 확률이, '매도'는 하락 확률이 높음을 의미합니다.</span>
                </div>
            </h3>
            <div class="space-y-4">${recommendations.map(r=>`
                <div class="p-3 rounded-lg bg-gray-50">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold">${r.name}</p>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${{'매수':'bg-red-100 text-red-800','매도':'bg-blue-100 text-blue-800','보유':'bg-gray-100 text-gray-800'}[r.signal]}">${r.signal}</span>
                    </div>
                    <div class="text-sm mt-2 text-gray-600">
                        <p>신뢰도: ${(r.confidence*100).toFixed(0)}%</p>
                        <p>목표가: ${r.targetPrice.toLocaleString()}원</p>
                    </div>
                </div>`).join('')}
            </div>`;
        }
        
        async function renderNewsPage(container){    
            const newsItems=await mockApi.getNews();
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">뉴스</h1>
            <p class="text-gray-500 mb-6">AI가 요약한 최신 경제 뉴스와 시장 감성 분석을 확인하세요.</p>
            <div class="space-y-6">${newsItems.map(item=>`
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-start mb-2">
                        <a href="${item.url}" target="_blank" class="text-lg font-bold hover:underline text-gray-900">${item.title}</a>
                        <span class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap ${item.sentiment==='positive'?'bg-red-100 text-red-800':'bg-blue-100 text-blue-800'}">${item.sentiment==='positive'?'긍정':'부정'}</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">${item.source} · ${item.time}</p>
                    <p class="text-gray-700 text-sm leading-relaxed">${item.summary}</p>
                </div>`).join('')}
            </div>`;
        }
        
        function renderMarketPage(container){    
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">시장 지표</h1>
            <p class="text-gray-500 mb-6">주요 시장 지표의 상세 정보를 확인하세요.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4">금 시세 (1kg)</h3>
                    <div class="h-64 mt-4" id="gold-chart"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4">WTI 유가 (휘발유)</h3>
                    <div class="h-64 mt-4" id="oil-chart"></div>
                </div>
            </div>`;
            renderMarketCharts();
        }
        
        function renderMockInvestmentPage(container) {    
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">모의 투자</h1>
            <p class="text-gray-500 mb-6">AI 예측을 기반으로 가상 투자를 경험하고, 투자 결과를 미리 확인해보세요.</p>
            <div class="bg-white p-6 rounded-lg shadow-md max-w-lg mx-auto">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <select id="mock-stock-select" class="p-2 border border-gray-300 rounded-lg col-span-2 sm:col-span-1">${state.kospiStocks.map(s=>`<option value="${s.code}">${s.name}</option>`).join('')}</select>
                    <input type="number" id="mock-quantity" placeholder="수량 (예: 10)" min="1" class="p-2 border border-gray-300 rounded-lg col-span-2 sm:col-span-1">
                </div>
                <button id="mock-calculate-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">결과 계산하기</button>
                <div id="mock-result" class="mt-6 pt-6 border-t">
                    <div class="flex items-center justify-center text-gray-500">
                        <p>종목과 수량을 입력하고 결과를 확인하세요.</p>
                        <div class="tooltip-container ml-2">
                            <span class="cursor-pointer text-blue-500">ⓘ</span>
                            <span class="tooltip-text">'현재 가치'는 현재가 x 수량, '예상 가치'는 AI가 7일 후로 예측한 종가 x 수량으로 계산됩니다. '예상 손익'은 두 가치의 차액입니다. 이는 실제 수익을 보장하지 않습니다.</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderMyPage(container) {
            const favoriteStocks = state.kospiStocks.filter(stock => state.favorites.includes(stock.code));
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">MY</h1>
            <p class="text-gray-500 mb-6">계정 정보를 관리하고 즐겨찾기 종목을 편집할 수 있습니다.</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">계정 정보 수정</h3>
                    <form id="update-user-form" class="space-y-4">
                        <p><strong class="text-gray-600 w-24 inline-block">아이디:</strong> ${state.currentUser.username}</p>
                        <p><strong class="text-gray-600 w-24 inline-block">이메일:</strong> ${state.currentUser.email}</p>
                        <div><label class="text-sm font-medium">새 비밀번호</label><input type="password" id="new-password" class="w-full mt-1 p-2 border border-gray-300 rounded" placeholder="새 비밀번호 입력"></div>
                        <div><label class="text-sm font-medium">비밀번호 확인</label><input type="password" id="confirm-password" class="w-full mt-1 p-2 border border-gray-300 rounded" placeholder="새 비밀번호 확인"></div>
                        <div class="pt-2 flex flex-col space-y-2">
                           <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition-colors">정보 저장</button>
                           <button type="button" id="delete-account-btn" class="w-full text-red-600 border border-red-500 py-2.5 rounded-lg hover:bg-red-50 transition-colors">회원 탈퇴</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">즐겨찾기 목록 (${favoriteStocks.length})</h3>
                    <ul id="my-favorites-list" class="divide-y max-h-96 overflow-y-auto">
                        ${favoriteStocks.length > 0 ? favoriteStocks.map(stock => `
                            <li class="flex justify-between items-center py-3">
                                <div><p class="font-medium">${stock.name}</p><p class="text-sm text-gray-400">${stock.code}</p></div>
                                <button data-stock-code="${stock.code}" class="my-remove-favorite-btn px-3 py-1 text-xs font-medium text-red-600 bg-red-100 rounded-full hover:bg-red-200">삭제</button>
                            </li>`).join('') : '<li class="text-center text-gray-500 py-8">즐겨찾는 종목이 없습니다.</li>'}
                    </ul>
                </div>
            </div>`;
        }

        // --- CHART RENDERING FUNCTIONS (with ApexCharts) ---
        function calculateSMA(data, period) {
            let sma = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].y[3]; // 종가 기준
                }
                sma.push({ x: data[i].x, y: sum / period });
            }
            return sma;
        }
        
        function renderDetailChart(historicalData, stockCode) {
            const chartContainer = document.getElementById('detail-chart-container');
            if(!chartContainer) return;
            if(state.charts.detail) state.charts.detail.destroy();

            document.querySelectorAll('.detail-chart-type-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.type === state.detailChartType);
                btn.classList.toggle('text-white', btn.dataset.type === state.detailChartType);
                btn.classList.toggle('bg-gray-200', btn.dataset.type !== state.detailChartType);
            });
            
            const series = state.detailChartType === 'line' ? 
                [{ name: '종가', type: 'line', data: historicalData.map(d => ({ x: d.x, y: d.y[3] })) }] :
                [{ name: '캔들', type: 'candlestick', data: historicalData }];
            
            const options = {
                series: series,
                chart: { type: 'candlestick', height: '100%', toolbar: { show: false } },
                xaxis: { type: 'datetime', labels: { datetimeFormatter: { month: "yy' MMM" } } },
                yaxis: { tooltip: { enabled: true }, labels: { formatter: (val) => val.toLocaleString() } },
                tooltip: { x: { format: 'yyyy년 MM월 dd일' } },
                plotOptions: { candlestick: { colors: { upward: '#ef4444', downward: '#3b82f6' } } }
            };

            state.charts.detail = new ApexCharts(chartContainer, options);
            state.charts.detail.render();
        }

        async function updateKospiChart(days) {
            const data = await mockApi.getKospiHistory(days);
            const chartContainer = document.getElementById('home-kospi-chart');
            if(!chartContainer) return;
            document.querySelectorAll('.kospi-chart-period-btn').forEach(btn => {
                const isSelected = parseInt(btn.dataset.days) === days;
                btn.classList.toggle('bg-blue-600', isSelected); btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('bg-gray-200', !isSelected);
            });
            if(state.charts.kospiHome) state.charts.kospiHome.destroy();

            const options = {
                series: [{ name: 'KOSPI', data: data }],
                chart: { type: 'area', height: '100%', sparkline: { enabled: true } },
                stroke: { curve: 'smooth', width: 2 },
                fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.1 } },
                colors: ['#3b82f6'],
                tooltip: {
                    x: { format: 'yyyy/MM/dd' },
                    y: { formatter: (val) => val.toFixed(2) }
                }
            };
            state.charts.kospiHome = new ApexCharts(chartContainer, options);
            state.charts.kospiHome.render();
        }

        async function updateAiChart(stockCode) {    
            const chartArea = document.getElementById('ai-chart-area');
            if (!chartArea) return;
            const stock = state.kospiStocks.find(s => s.code === stockCode);
            chartArea.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold">${stock?.name || ''} 분석</h3>
                    <div class="flex space-x-1 text-xs">
                        <button class="ai-chart-type-btn px-3 py-1 rounded-full" data-type="candlestick">캔들차트</button>
                        <button class="ai-chart-type-btn px-3 py-1 rounded-full" data-type="line">선차트</button>
                    </div>
                </div>
                <div class="chart-container" id="ai-chart-wrapper"></div>
                <div id="ai-indicators" class="mt-2 flex items-center space-x-2">
                    <span class="text-sm font-medium">보조지표:</span>
                    <label class="flex items-center text-sm cursor-pointer"><input type="checkbox" id="sma-20-checkbox" class="mr-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> 20일 이동평균선(SMA)</label>
                </div>`;

            document.querySelectorAll('.ai-chart-type-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.type === state.aiChartType);
                btn.classList.toggle('text-white', btn.dataset.type === state.aiChartType);
                btn.classList.toggle('bg-gray-200', btn.dataset.type !== state.aiChartType);
            });

            const { historicalData, predictionData } = await mockApi.getStockChartData(stockCode);
            if (state.charts.ai) state.charts.ai.destroy();
            
            const lastHistoricalPoint = historicalData[historicalData.length - 1];
            const predictionLine = [{ x: lastHistoricalPoint.x, y: lastHistoricalPoint.y[3] }, ...predictionData.map(d => ({ x: d.time, y: d.value }))];
            
            let series = [];
            if (state.aiChartType === 'line') {
                series.push({ name: '과거 종가', type: 'line', data: historicalData.map(d => ({ x: d.x, y: d.y[3] })) });
            } else {
                series.push({ name: '과거 주가', type: 'candlestick', data: historicalData });
            }
            series.push({ name: 'AI 예측', type: 'area', data: predictionLine });

            const sma20 = calculateSMA(historicalData, 20);

            const options = {
                series: series,
                chart: { type: 'line', height: '100%' },
                tooltip: { shared: true, intersect: false, y: { formatter: (val) => val.toLocaleString() } },
                xaxis: { type: 'datetime' },
                yaxis: { labels: { formatter: (val) => val.toLocaleString() } },
                stroke: { width: [2, 2], dashArray: [0, 5] },
                colors: ['#3b82f6', '#f97316'],
                plotOptions: { candlestick: { colors: { upward: '#ef4444', downward: '#3b82f6' } } },
                legend: { horizontalAlign: 'left' },
                fill: { type: ['solid', 'gradient'], gradient: { opacityFrom: 0.3, opacityTo: 0 } },
            };
            
            state.charts.ai = new ApexCharts(document.getElementById('ai-chart-wrapper'), options);
            state.charts.ai.render();

            document.getElementById('sma-20-checkbox').addEventListener('change', (e) => {
                if(e.target.checked) {
                    state.charts.ai.appendSeries({ name: 'SMA 20', type: 'line', data: sma20, color: '#6366f1' });
                } else {
                    state.charts.ai.removeSeries('SMA 20');
                }
            });
        }
        
        async function renderMarketCharts() {
            const goldData = await mockApi.getKospiHistory(365);
            const oilData = await mockApi.getKospiHistory(365);
            if (!document.getElementById('gold-chart') || !document.getElementById('oil-chart')) return;

            const baseOptions = {
                chart: { type: 'line', height: '100%', toolbar: { show: false } },
                stroke: { curve: 'smooth', width: 2 },
                xaxis: { type: 'datetime' }
            };

            const goldOptions = { ...baseOptions, series: [{ name: '금 시세', data: goldData.map(d => ({x: d.x, y: d.y * 38000}))}], colors: ['#f59e0b'], yaxis: { labels: { formatter: (val) => `${(val/1000000).toFixed(0)}백만` } } };
            const oilOptions = { ...baseOptions, series: [{ name: '유가', data: oilData.map(d => ({x: d.x, y: d.y * 0.6 + 1000}))}], colors: ['#4f46e5'], yaxis: { labels: { formatter: (val) => `${val.toLocaleString()}원` } } };

            if(state.charts.gold) state.charts.gold.destroy();
            state.charts.gold = new ApexCharts(document.getElementById('gold-chart'), goldOptions);
            state.charts.gold.render();
            
            if(state.charts.oil) state.charts.oil.destroy();
            state.charts.oil = new ApexCharts(document.getElementById('oil-chart'), oilOptions);
            state.charts.oil.render();
        }

        // ===================================================================================
        // GUIDEBOOK (TUTORIAL)
        // ===================================================================================
        const guidebookSteps = [
            {
                title: 'NextStep 투어 시작!',
                content: '안녕하세요! NextStep의 핵심 기능을 쉽고 빠르게 알려드릴게요. <br>먼저 홈 화면의 <strong>위젯</strong>부터 시작해볼까요?',
                target: null,
                action: 'click',
                buttonText: '시작하기',
                setup: () => navigate('home'),
            },
            {
                title: '위젯 편집',
                content: '이 버튼을 눌러 홈 화면에 표시할 위젯을 추가하거나 순서를 바꿀 수 있습니다. <br><strong>클릭해보세요!</strong>',
                target: '#widget-edit-toggle',
                action: 'click',
                position: { top: '80px', left: '20px' }
            },
            {
                title: '위젯 순서 변경',
                content: '이제 위젯 편집 모드가 되었어요. 이 <strong>안내 문구</strong>처럼 위젯을 드래그해서 원하는 위치로 옮길 수 있습니다.',
                target: '#widget-drag-guide',
                action: 'click',
                buttonText: '다음',
                position: 'bottom',
            },
            {
                title: '국내 주식 탐색',
                content: '이제 국내 주식 시장을 살펴보러 가볼까요? 상단의 <strong>국내</strong> 메뉴를 클릭하세요.',
                target: '.nav-link[data-page="domestic"]',
                action: 'click',
                position: 'bottom',
            },
            {
                title: '종목 상세 정보',
                content: '관심 있는 종목의 행을 클릭하면 상세 정보를 볼 수 있습니다. <br>가이드북을 위해 임시로 생성된 <strong>NextStep 혁신기술</strong>을 클릭해볼까요?',
                target: '.stock-row[data-stock-code="TUTORIAL-01"]',
                action: 'click',
                position: 'bottom',
                setup: () => {
                    const tutorialStock = { code: 'TUTORIAL-01', name: 'NextStep 혁신기술', price: 50000, change: 2500, changeRate: 5.26, volume: 1234567 };
                    state.kospiStocks.unshift(tutorialStock);
                    renderStockList(state.kospiStocks);
                },
                cleanup: () => {
                    state.kospiStocks = state.kospiStocks.filter(s => s.code !== 'TUTORIAL-01');
                    if (state.currentPage === 'domestic') renderStockList(state.kospiStocks);
                }
            },
            {
                title: '상세 차트와 AI 분석',
                content: '이곳에서 상세한 주가 차트를 확인하고, 더 깊이 있는 분석을 위해 <strong>AI 분석 바로가기</strong> 버튼을 누를 수 있습니다. 클릭해보세요!',
                target: '#go-to-ai-page-from-modal',
                action: 'click',
                position: 'top',
            },
            {
                title: 'AI 분석 페이지',
                content: 'AI 분석 페이지로 이동했습니다! 여기서는 과거 주가와 함께 AI가 예측한 미래 주가 추세를 볼 수 있습니다.',
                target: '#ai-chart-area',
                action: 'click',
                buttonText: '다음',
                position: 'bottom',
            },
            {
                title: '보조지표 활용',
                content: '차트 아래에서 <strong>보조지표</strong>를 추가하여 기술적 분석을 할 수 있습니다. <br>체크박스를 클릭해 <strong>20일 이동평균선</strong>을 추가해보세요!',
                target: '#ai-indicators',
                action: 'click_child',
                childSelector: '#sma-20-checkbox',
                position: 'top',
            },
            {
                title: '투어 완료!',
                content: '축하합니다! NextStep의 핵심 기능을 모두 둘러보셨습니다. <br>이제 자유롭게 탐색하며 성공적인 투자를 시작해보세요!',
                target: null,
                action: 'click',
                buttonText: '완료',
            },
        ];

        function startGuidebook() {
            state.isGuidebookActive = true;
            state.guidebookStep = 0;
            renderGuidebookStep();
        }
        
        async function renderGuidebookStep() {
            const step = guidebookSteps[state.guidebookStep];
            if (!step) {
                endGuidebook();
                return;
            }

            if (step.setup) await step.setup();

            document.querySelectorAll('.guidebook-highlight').forEach(el => el.classList.remove('guidebook-highlight'));

            guidebookContainer.innerHTML = `<div id="guidebook-backdrop"></div>`;
            const modal = document.createElement('div');
            modal.id = 'guidebook-modal';
            modal.innerHTML = `
                <p class="text-sm font-bold text-blue-600 mb-1">가이드 (${state.guidebookStep + 1}/${guidebookSteps.length})</p>
                <h3 class="text-xl font-bold mb-3">${step.title}</h3>
                <p class="text-gray-600 mb-5 text-sm leading-6">${step.content}</p>
                <div class="flex items-center justify-between">
                    ${state.guidebookStep > 0 ? `<button id="guidebook-prev" class="text-sm text-gray-500 hover:text-black">이전</button>` : '<div></div>'}
                    ${step.buttonText ? `<button id="guidebook-next" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">${step.buttonText}</button>` : ''}
                </div>
                ${state.guidebookStep === 0 ? `<div class="mt-4 text-center"><label class="flex items-center justify-center text-xs text-gray-500 cursor-pointer"><input type="checkbox" id="guidebook-dont-show-again" class="mr-2"> 다시 보지 않기</label></div>` : ''}
            `;
            guidebookContainer.appendChild(modal);

            const targetElement = step.target ? document.querySelector(step.target) : null;

            if (targetElement) {
                targetElement.classList.add('guidebook-highlight');
                const rect = targetElement.getBoundingClientRect();

                if (step.position === 'bottom') {
                    modal.style.top = `${rect.bottom + 15}px`;
                    modal.style.left = `${rect.left + rect.width / 2 - modal.offsetWidth / 2}px`;
                } else if (step.position === 'top') {
                    modal.style.top = `${rect.top - modal.offsetHeight - 15}px`;
                    modal.style.left = `${rect.left + rect.width / 2 - modal.offsetWidth / 2}px`;
                } else if (typeof step.position === 'object') {
                    modal.style.top = step.position.top;
                    modal.style.left = step.position.left;
                } else { // default to center if no target
                    modal.style.top = '50%';
                    modal.style.left = '50%';
                    modal.style.transform = 'translate(-50%, -50%)';
                }
                 // Adjust if modal is off-screen
                const modalRect = modal.getBoundingClientRect();
                if (modalRect.right > window.innerWidth - 10) modal.style.left = `${window.innerWidth - modal.offsetWidth - 10}px`;
                if (modalRect.left < 10) modal.style.left = '10px';


                const actionHandler = (e) => {
                    if (step.action === 'click_child') {
                         if (!e.target.closest(step.childSelector)) return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    nextGuidebookStep(actionHandler);
                };
                targetElement.addEventListener(step.action.startsWith('click') ? 'click' : 'mouseover', actionHandler, { once: true });
            }
        }
        
        function nextGuidebookStep(prevHandler = null) {
            const currentStep = guidebookSteps[state.guidebookStep];
            if (currentStep.cleanup) currentStep.cleanup();
            if (currentStep.target && prevHandler) {
                 document.querySelector(currentStep.target)?.removeEventListener(currentStep.action.startsWith('click') ? 'click' : 'mouseover', prevHandler);
            }

            state.guidebookStep++;
            renderGuidebookStep();
        }

        function prevGuidebookStep() {
             const currentStep = guidebookSteps[state.guidebookStep];
             if (currentStep.cleanup) currentStep.cleanup();
             state.guidebookStep--;
             renderGuidebookStep();
        }
        
        function endGuidebook() {
            document.querySelectorAll('.guidebook-highlight').forEach(el => el.classList.remove('guidebook-highlight'));
            guidebookContainer.innerHTML = '';
            state.isGuidebookActive = false;
        }

        // ===================================================================================
        // EVENT HANDLERS & LOGIC
        // ===================================================================================
        function setupEventListeners() {
            document.body.addEventListener('click', handleClicks);
            document.body.addEventListener('submit', handleSubmits);
            document.body.addEventListener('change', handleChanges);
            document.body.addEventListener('input', handleInputs);
            document.body.addEventListener('dragstart', handleDragStart);
            document.body.addEventListener('dragover', handleDragOver);
            document.body.addEventListener('dragleave', handleDragLeave);
            document.body.addEventListener('drop', handleDrop);
            document.body.addEventListener('dragend', handleDragEnd);
        }

        function handleClicks(e) {
            if (state.isGuidebookActive) {
                if (e.target.id === 'guidebook-next') nextGuidebookStep();
                if (e.target.id === 'guidebook-prev') prevGuidebookStep();
                if(e.target.closest('.guidebook-highlight')) return; // Allow interaction with highlighted element
            }
            const navLink = e.target.closest('.nav-link, a[data-page]');
            if (navLink) { e.preventDefault(); navigate(navLink.dataset.page); }
            if (e.target.closest('#go-to-signup')) { e.preventDefault(); renderSignupPage(); }
            if (e.target.closest('#go-to-login')) { e.preventDefault(); renderLoginPage(); }
            if (e.target.closest('#logout-btn')) handleLogout();
            if (e.target.closest('#close-detail-modal')) closeModal();
            if (e.target.closest('#go-to-ai-page-from-modal')) { navigate('ai', { stockCode: e.target.closest('#go-to-ai-page-from-modal').dataset.stockCode }); closeModal(); }
            const stockRow = e.target.closest('.stock-row');
            if (stockRow && !e.target.closest('.toggle-favorite-btn')) { renderStockDetailModal(stockRow.dataset.stockCode); }
            if (e.target.closest('.toggle-favorite-btn')) { e.stopPropagation(); toggleFavorite(e.target.closest('.toggle-favorite-btn').dataset.stockCode); }
            if (e.target.closest('.my-remove-favorite-btn')) toggleFavorite(e.target.dataset.stockCode);
            const sortableHeader = e.target.closest('.sortable-header');
            if (sortableHeader) handleSort(sortableHeader.dataset.sortKey);
            if (e.target.closest('#mock-calculate-btn')) handleMockCalculation();
            if (e.target.closest('#delete-account-btn')) handleDeleteAccount();
            if (e.target.closest('#widget-edit-toggle')) toggleWidgetEditMode();
            if (e.target.closest('.remove-widget-btn')) removeWidget(e.target.dataset.widgetId);
            if (e.target.closest('.add-widget-btn')) addWidget(e.target.dataset.widgetType);
            const widgetStock = e.target.closest('.widget li[data-stock-code]');
            if(widgetStock && !state.isWidgetEditMode) renderStockDetailModal(widgetStock.dataset.stockCode);
            if(e.target.closest('.kospi-chart-period-btn')) updateKospiChart(parseInt(e.target.closest('.kospi-chart-period-btn').dataset.days));
            const aiQuickSelectBtn = e.target.closest('.ai-quick-select-btn');
            if (aiQuickSelectBtn) {
                const code = aiQuickSelectBtn.dataset.stockCode;
                state.currentParams = { stockCode: code };
                updateAiChart(code);
                document.getElementById('ai-stock-search').value = state.kospiStocks.find(s=>s.code===code).name;
                document.getElementById('ai-search-results').innerHTML = '';
            }
            const aiSearchResult = e.target.closest('.ai-search-result-item');
             if (aiSearchResult) {
                const code = aiSearchResult.dataset.stockCode;
                state.currentParams = { stockCode: code };
                updateAiChart(code);
                document.getElementById('ai-stock-search').value = aiSearchResult.textContent.split('(')[0].trim();
                document.getElementById('ai-search-results').innerHTML = '';
            }
            if(e.target.closest('.detail-chart-type-btn')) {
                state.detailChartType = e.target.closest('.detail-chart-type-btn').dataset.type;
                const stockCode = document.getElementById('go-to-ai-page-from-modal').dataset.stockCode;
                mockApi.getStockChartData(stockCode).then(({historicalData}) => renderDetailChart(historicalData, stockCode));
            }
            if(e.target.closest('.ai-chart-type-btn')) {
                state.aiChartType = e.target.closest('.ai-chart-type-btn').dataset.type;
                if(state.currentParams?.stockCode) updateAiChart(state.currentParams.stockCode);
            }
        }

        function handleSubmits(e) {
            e.preventDefault();
            if (e.target.id === 'login-form') handleLogin(e.target);
            if (e.target.id === 'signup-form') handleSignup(e.target);
            if (e.target.id === 'update-user-form') handleUpdateUser(e.target);
        }

        function handleChanges(e) {
            if (e.target.id === 'guidebook-dont-show-again') {
                localStorage.setItem('nextstep-hide-guidebook', e.target.checked);
            }
        }

        function handleInputs(e) {
            if (e.target.id === 'stock-search') {
                const searchTerm = e.target.value.toLowerCase();
                renderStockList(state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm)));
            }
            if (e.target.id === 'ai-stock-search') {
                const searchTerm = e.target.value.toLowerCase();
                const resultsContainer = document.getElementById('ai-search-results');
                if(!searchTerm) {
                    resultsContainer.innerHTML = ''; return;
                }
                const filtered = state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm)).slice(0, 5);
                resultsContainer.innerHTML = filtered.length > 0 ?    
                    `<ul class="bg-white border rounded-md shadow-lg">${filtered.map(s => `
                        <li class="ai-search-result-item p-2 hover:bg-gray-100 cursor-pointer" data-stock-code="${s.code}">
                            ${s.name} (${s.code})
                        </li>`).join('')}</ul>` :    
                    `<div class="p-2 text-sm text-gray-500">검색 결과가 없습니다.</div>`;
            }
        }
        
        function handleDragStart(e) { if(e.target.classList.contains('widget')) { state.draggedWidgetId = e.target.id; e.target.classList.add('dragging'); } }
        function handleDragOver(e) { if(state.draggedWidgetId) { e.preventDefault(); const target = e.target.closest('.widget'); if(target && target.id !== state.draggedWidgetId) target.classList.add('drag-over'); } }
        function handleDragLeave(e) { const target = e.target.closest('.widget'); if(target) target.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault();
            const targetWidget = e.target.closest('.widget');
            if (!targetWidget || targetWidget.id === state.draggedWidgetId) return;
            const draggedIndex = state.widgets.findIndex(w => w.id === state.draggedWidgetId);
            const targetIndex = state.widgets.findIndex(w => w.id === targetWidget.id);
            const [draggedItem] = state.widgets.splice(draggedIndex, 1);
            state.widgets.splice(targetIndex, 0, draggedItem);
            localStorage.setItem('nextstep-widgets', JSON.stringify(state.widgets));
            renderWidgets();
        }
        function handleDragEnd() { state.draggedWidgetId = null; document.querySelectorAll('.widget').forEach(w => w.classList.remove('dragging', 'drag-over')); }
        
        // --- Core Logic Functions ---
        function navigate(page, params = null) { state.currentPage = page; state.currentParams = params; renderPage(); }
        async function handleLogin(form) {
            try {
                const { accessToken, user } = await mockApi.login(form.username.value, form.password.value);
                state.isLoggedIn = true;
                state.currentUser = user;
                localStorage.setItem('nextstep-token', accessToken);
                localStorage.setItem('nextstep-user', JSON.stringify(user));
                initializeApp();
            } catch (err) { renderLoginPage(err.message); }
        }
        async function handleSignup(form) {
            try {
                await mockApi.signup(form.email.value, form.username.value, form.password.value);
                alert("회원가입이 완료되었습니다. 로그인해주세요.");
                renderLoginPage();
            } catch (err) { renderSignupPage(err.message); }
        }
        function handleLogout() {
            state.isLoggedIn = false;
            state.currentUser = null;
            localStorage.removeItem('nextstep-token');
            localStorage.removeItem('nextstep-user');
            sessionStorage.removeItem('guidebook-shown');
            renderApp();
        }
        async function handleUpdateUser(form) {
            const newPassword = form.elements['new-password'].value;
            const confirmPassword = form.elements['confirm-password'].value;
            if (!newPassword) { alert("새 비밀번호를 입력해주세요."); return; }
            if (newPassword !== confirmPassword) { alert("비밀번호가 일치하지 않습니다."); return; }
            try {
                const result = await mockApi.updateUser(state.currentUser.username, newPassword);
                alert(result.message);
                form.reset();
            } catch(e) { alert(e.message); }
        }
        async function handleDeleteAccount() {
            if (confirm("정말로 회원 탈퇴를 하시겠습니까? 모든 데이터가 영구적으로 삭제됩니다.")) {
                try {
                    await mockApi.deleteUser(state.currentUser.username);
                    alert("회원 탈퇴가 완료되었습니다.");
                    handleLogout();
                } catch(e) { alert(e.message); }
            }
        }
        async function handleMockCalculation() {
            const code = document.getElementById('mock-stock-select').value;
            const quantity = parseInt(document.getElementById('mock-quantity').value, 10);
            const resultDiv = document.getElementById('mock-result');
            if (isNaN(quantity) || quantity <= 0) { resultDiv.innerHTML = `<p class="text-red-500 text-center">올바른 수량을 입력하세요.</p>`; return; }
            
            const stock = state.kospiStocks.find(s => s.code === code);
            const { predictionData } = await mockApi.getStockChartData(code);
            const currentValue = stock.price * quantity;
            const futureValue = predictionData[6].value * quantity;
            const pnl = futureValue - currentValue;
            const pnlColor = pnl > 0 ? 'text-red-500' : 'text-blue-500';

            resultDiv.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between"><span>현재 가치:</span> <strong>${Math.round(currentValue).toLocaleString()}원</strong></div>
                    <div class="flex justify-between"><span>1주일 후 예상 가치:</span> <strong>${Math.round(futureValue).toLocaleString()}원</strong></div>
                    <div class="flex justify-between font-bold text-lg ${pnlColor}"><span>예상 손익:</span> <strong>${pnl > 0 ? '+' : ''}${Math.round(pnl).toLocaleString()}원</strong></div>
                </div>`;
        }

        function toggleFavorite(stockCode) {
            const index = state.favorites.indexOf(stockCode);
            if (index > -1) state.favorites.splice(index, 1); else state.favorites.push(stockCode);
            localStorage.setItem('nextstep-favorites', JSON.stringify(state.favorites));
            
            const pageContent = document.querySelector('.page-content');
            if (state.currentPage === 'domestic') {
                const searchTerm = document.getElementById('stock-search')?.value.toLowerCase() || '';
                const filteredStocks = state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm));
                renderStockList(filteredStocks);
            } else if (state.currentPage === 'my' && pageContent) {
                renderMyPage(pageContent);
            } else if (state.currentPage === 'home' && pageContent) {
                renderHomePage(pageContent);
            } else if (state.currentPage === 'ai' && pageContent) {
                renderAiAnalysisPage(pageContent);
            }
        }
        function handleSort(key){
            if (state.domesticSort.key === key) {
                state.domesticSort.order = state.domesticSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                state.domesticSort.key = key; state.domesticSort.order = 'desc';
            }
            const searchTerm = document.getElementById('stock-search')?.value.toLowerCase() || '';
            const filteredStocks = state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm));
            renderStockList(filteredStocks);
        }
        function toggleWidgetEditMode() { state.isWidgetEditMode = !state.isWidgetEditMode; renderHomePage(document.querySelector('.page-content')); }
        function removeWidget(widgetId) { state.widgets = state.widgets.filter(w => w.id !== widgetId); localStorage.setItem('nextstep-widgets', JSON.stringify(state.widgets)); renderHomePage(document.querySelector('.page-content')); }
        function addWidget(widgetType) {
            if (!state.widgets.some(w => w.type === widgetType)) {
                state.widgets.push({ id: `widget-${Date.now()}`, type: widgetType });
                localStorage.setItem('nextstep-widgets', JSON.stringify(state.widgets));
                renderHomePage(document.querySelector('.page-content'));
            }
        }
        function closeModal() { modalContainer.innerHTML = ''; }
        
        // ===================================================================================
        // INITIALIZATION
        // ===================================================================================
        async function initializeApp() {
            setupEventListeners();
            
            if (state.isLoggedIn) {
                state.kospiStocks = await mockApi.getKospiStocks();
            }
            
            renderApp();
        }

        initializeApp();
    </script>
</body>
</html>