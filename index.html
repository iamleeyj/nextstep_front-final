<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextStep - AI ì£¼ì‹ ì˜ˆì¸¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/build/chartjs-chart-financial.min.js"></script>

    <style>
        /* Google Fonts Import */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Page transition effect */
        .page-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active state for buttons */
        .btn-active:active { transform: scale(0.97); transition: transform 0.1s; }
        .chart-container { position: relative; height: 60vh; width: 100%; }
        .stock-row { cursor: pointer; }
        
        /* Draggable widget styles */
        .widget.dragging { opacity: 0.5; border: 2px dashed #3b82f6; }
        .widget.drag-over { transform: scale(1.02); }

        /* Tooltip styles */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip-text { visibility: hidden; width: 250px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: normal; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Tutorial Overlay Styles */
        #tutorial-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); z-index: 9998; }
        #tutorial-spotlight { position: fixed; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); z-index: 9999; transition: all 0.4s ease-in-out; }
        #tutorial-popover { position: fixed; background: white; color: #333; padding: 20px; border-radius: 8px; max-width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; transition: opacity 0.3s, transform 0.3s; }
        .tutorial-arrow { position: absolute; width: 0; height: 0; border-style: solid; }
        .tutorial-arrow.up { border-width: 0 10px 10px 10px; border-color: transparent transparent white transparent; top: -10px; left: calc(50% - 10px); }
        .tutorial-arrow.down { border-width: 10px 10px 0 10px; border-color: white transparent transparent transparent; bottom: -10px; left: calc(50% - 10px); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-300">

    <div id="app" class="flex flex-col min-h-screen"></div>
    <div id="modal-container"></div>
    <div id="tutorial-container"></div>

    <script type="module">
        // ===================================================================================
        // SVG ICONS
        // ===================================================================================
        const icons = {
            arrowUp: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>`,
            arrowDown: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`,
            starFilled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`,
            starOutline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        };

        // ===================================================================================
        // MOCK DATA (ë°±ì—”ë“œ API ëª¨ì˜ ë°ì´í„°)
        // ===================================================================================
        const mockApi = {
            login: (username, password) => {
                if (username === 'test' && password === 'test1234') {
                    return Promise.resolve({ accessToken: 'mock-jwt-token-string', user: { email: 'test@nextstep.com', username: 'test' } });
                }
                const users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                const user = users.find(u => u.username === username && u.password === password);
                if (user) return Promise.resolve({ accessToken: `mock-jwt-for-${user.username}`, user });
                return Promise.reject({ message: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' });
            },
            signup: (email, username, password) => {
                let users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                if (users.some(u => u.username === username)) return Promise.reject({ message: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.' });
                if (users.some(u => u.email === email)) return Promise.reject({ message: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.' });
                const newUser = { email, username, password };
                users.push(newUser);
                localStorage.setItem('nextstep-users', JSON.stringify(users));
                return Promise.resolve({ message: 'íšŒì›ê°€ì… ì„±ê³µ!' });
            },
            updateUser: (username, newPassword) => {
                let users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex > -1) {
                    users[userIndex].password = newPassword;
                    localStorage.setItem('nextstep-users', JSON.stringify(users));
                    return Promise.resolve({ message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
                }
                return Promise.reject({ message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
            },
            deleteUser: (username) => {
                let users = JSON.parse(localStorage.getItem('nextstep-users')) || [];
                users = users.filter(u => u.username !== username);
                localStorage.setItem('nextstep-users', JSON.stringify(users));
                return Promise.resolve({ message: 'íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' });
            },
            getKospiStocks: () => Promise.resolve([
                { code: '005930', name: 'ì‚¼ì„±ì „ì', price: 78000, change: 1200, changeRate: 1.56, volume: 15000000 },
                { code: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', price: 130000, change: -2000, changeRate: -1.52, volume: 8000000 },
                { code: '035420', name: 'NAVER', price: 215000, change: 500, changeRate: 0.23, volume: 1200000 },
                { code: '035720', name: 'ì¹´ì¹´ì˜¤', price: 55000, change: -800, changeRate: -1.43, volume: 5500000 },
                { code: '207940', name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', price: 780000, change: 10000, changeRate: 1.30, volume: 300000 },
                { code: '005380', name: 'í˜„ëŒ€ì°¨', price: 200000, change: 3000, changeRate: 1.52, volume: 900000 },
                { code: '005490', name: 'POSCOí™€ë”©ìŠ¤', price: 410000, change: -5000, changeRate: -1.20, volume: 750000 },
                { code: '051910', name: 'LGí™”í•™', price: 450000, change: 7000, changeRate: 1.58, volume: 600000 },
            ]),
            getStockChartData: (stockCode) => {
                const today = new Date();
                const historicalData = [];
                const predictionData = [];
                let lastClose = Math.random() * 100000 + 50000;

                for (let i = 365 * 3; i > 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    if (date.getDay() === 0 || date.getDay() === 6) continue;
                    const open = lastClose * (1 + (Math.random() - 0.5) * 0.05);
                    const high = Math.max(open, lastClose) * (1 + Math.random() * 0.03);
                    const low = Math.min(open, lastClose) * (1 - Math.random() * 0.03);
                    const close = low + Math.random() * (high - low);
                    historicalData.push({ t: date.getTime(), o: open, h: high, l: low, c: close });
                    lastClose = close;
                }
                
                let lastPrediction = historicalData.length > 0 ? historicalData[historicalData.length - 1].c : lastClose;
                for (let i = 1; i <= 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);
                    const prediction = lastPrediction * (1 + (Math.random() - 0.45) * 0.03);
                    predictionData.push({ time: date.getTime(), value: prediction });
                    lastPrediction = prediction;
                }
                return Promise.resolve({ historicalData, predictionData });
            },
            getIndices: () => Promise.resolve({
                kospi: { value: 2750.43, change: 12.33, changeRate: 0.45 },
                gold: { price1kg: 85000000, price100g: 8550000 },
                oil: { gasoline: 1750, diesel: 1680, kerosene: 1200 },
            }),
            getAiPicks: () => Promise.resolve([
                { code: '005930', name: 'ì‚¼ì„±ì „ì', reason: 'ë°˜ë„ì²´ ì—…í™© ê°œì„  ê¸°ëŒ€' },
                { code: '005380', name: 'í˜„ëŒ€ì°¨', reason: 'ì‹ ê·œ ì „ê¸°ì°¨ ëª¨ë¸ íŒë§¤ í˜¸ì¡°' },
            ]),
            getAiRecommendations: () => Promise.resolve([
                { code: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', signal: 'ë§¤ìˆ˜', confidence: 0.85, targetPrice: 145000 },
                { code: '035720', name: 'ì¹´ì¹´ì˜¤', signal: 'ë³´ìœ ', confidence: 0.65, targetPrice: 58000 },
                { code: '005490', name: 'POSCOí™€ë”©ìŠ¤', signal: 'ë§¤ë„', confidence: 0.78, targetPrice: 390000 },
            ]),
            getNews: () => Promise.resolve([
                { id: 1, url: 'https://www.etnews.com', title: "ì‚¼ì„±ì „ì, AI ì¹© 'ë§ˆí•˜-1' ê³µê°œ...", source: "ì „ìì‹ ë¬¸", time: "2ì‹œê°„ ì „", summary: "ì‚¼ì„±ì „ìê°€ ìì²´ ê°œë°œí•œ AI ì¹© 'ë§ˆí•˜-1'ì„ ê³µê°œí•˜ë©° ì—”ë¹„ë””ì•„ì˜ ì•„ì„±ì— ë„ì „í•©ë‹ˆë‹¤...", sentiment: "positive" },
                { id: 2, url: 'https://www.yna.co.kr', title: "í˜„ëŒ€ì°¨, ë¯¸êµ­ ì „ê¸°ì°¨ ì‹œì¥ ì ìœ ìœ¨ 10% ëŒíŒŒ", source: "ì—°í•©ë‰´ìŠ¤", time: "5ì‹œê°„ ì „", summary: "í˜„ëŒ€ìë™ì°¨ê°€ ì•„ì´ì˜¤ë‹‰ ì‹œë¦¬ì¦ˆì˜ ì¸ê¸°ì— í˜ì…ì–´ ë¯¸êµ­ ì „ê¸°ì°¨ ì‹œì¥ì—ì„œ 11%ì˜ ì ìœ ìœ¨ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤...", sentiment: "positive" },
            ]),
            getKospiHistory: (days) => {
                const data = []; let lastValue = 2750; const today = new Date();
                for(let i=days; i>0; i--){
                    const date = new Date(today); date.setDate(today.getDate() - i);
                    if (date.getDay() === 0 || date.getDay() === 6) continue;
                    lastValue *= (1 + (Math.random() - 0.48) * 0.015);
                    data.push({time: date.getTime(), value: lastValue});
                }
                return Promise.resolve(data);
            },
        };

        // ===================================================================================
        // APPLICATION STATE
        // ===================================================================================
        const state = {
            isLoggedIn: !!localStorage.getItem('nextstep-token'),
            currentUser: JSON.parse(localStorage.getItem('nextstep-user')),
            currentPage: 'home',
            currentParams: null,
            kospiStocks: [],
            favorites: JSON.parse(localStorage.getItem('nextstep-favorites')) || ['005930', '035420'],
            widgets: JSON.parse(localStorage.getItem('nextstep-widgets')) || [
                { id: 'indices', type: 'indices' }, { id: 'kospiChart', type: 'kospiChart' },
                { id: 'topVolume', type: 'topVolume' }, { id: 'favorites', type: 'favorites' },
            ],
            isWidgetEditMode: false,
            domesticSort: { key: 'volume', order: 'desc' },
            charts: {},
            draggedWidgetId: null,
            detailChartType: 'line',
            detailChartIndicators: { sma20: false, ema60: false },
            aiChartType: 'candlestick',
            tutorial: {
                active: false,
                step: 0,
                seen: localStorage.getItem('nextstep-tutorial-seen') === 'true',
                stockCode: 'T0001',
                stockName: '(íŠœí† ë¦¬ì–¼) ë„¥ìŠ¤íŠ¸ìŠ¤í…'
            }
        };

        // ===================================================================================
        // UTILITY FUNCTIONS
        // ===================================================================================
        function formatKoreanDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function calculateSMA(data, period) {
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((acc, val) => acc + val.c, 0);
                result.push({ t: data[i].t, y: sum / period });
            }
            return result;
        }

        function calculateEMA(data, period) {
            const result = [];
            const k = 2 / (period + 1);
            if (data.length < period) return [];
            
            let sma = data.slice(0, period).reduce((acc, val) => acc + val.c, 0) / period;
            result.push({ t: data[period - 1].t, y: sma });

            for (let i = period; i < data.length; i++) {
                const ema = (data[i].c * k) + (result[result.length - 1].y * (1 - k));
                result.push({ t: data[i].t, y: ema });
            }
            return result;
        }

        // ===================================================================================
        // RENDER FUNCTIONS
        // ===================================================================================
        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        const tutorialContainer = document.getElementById('tutorial-container');
        
        function renderApp() {
            if (!state.isLoggedIn) {
                renderLoginPage();
                return;
            }
            appContainer.innerHTML = `
                <header id="app-header" class="bg-white shadow-md sticky top-0 z-40 transition-colors duration-300"></header>
                <main id="app-main" class="flex-grow container mx-auto p-4 md:p-6"></main>`;
            renderPage();
            
            if (localStorage.getItem('nextstep-hide-welcome') !== 'true' && !sessionStorage.getItem('welcome-shown') && !state.tutorial.seen) {
                renderWelcomeModal();
                sessionStorage.setItem('welcome-shown', 'true');
            }
        }

        function renderHeader() {
            const header = document.getElementById('app-header');
            if (!header) return;
            const navLinks = [
                { id: 'home', text: 'í™ˆ' }, { id: 'domestic', text: 'êµ­ë‚´' }, { id: 'news', text: 'ë‰´ìŠ¤' },
                { id: 'market', text: 'ì‹œì¥' }, { id: 'ai', text: 'AI ë¶„ì„' }, { id: 'mock', text: 'ëª¨ì˜íˆ¬ì' }, { id: 'my', text: 'MY' }
            ];
            const navItems = navLinks.map(link => `<a href="#" data-page="${link.id}" class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-colors ${state.currentPage === link.id ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-200'}">${link.text}</a>`).join('');
            header.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <a href="#" data-page="home" class="flex-shrink-0 flex items-center gap-2">
                             <svg class="h-10 w-auto" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" fill="#3B82F6"/>
                                <path d="M12 2L17 4.5V13.5L12 11V2Z" fill="#60A5FA"/>
                                <path d="M12 11L7 13.5V20L12 22V11Z" fill="#2563EB"/>
                             </svg>
                             <span class="font-bold text-xl text-gray-800">NextStep</span>
                        </a>
                    </div>
                    <nav class="hidden md:flex flex-grow justify-center space-x-4">${navItems}</nav>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-700"><strong>${state.currentUser.username}</strong>ë‹˜</span>
                        <button id="logout-btn" class="text-sm font-medium text-gray-500 hover:text-blue-600 btn-active">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div></div>`;
        }
        
        function renderPage() {
            Object.values(state.charts).forEach(chart => chart?.destroy());
            state.charts = {};
            const main = document.getElementById('app-main');
            if (!main) return;
            main.innerHTML = '<div class="page-content"></div>';
            const pageContent = main.querySelector('.page-content');
            
            switch (state.currentPage) {
                case 'home': renderHomePage(pageContent); break;
                case 'domestic': renderDomesticPage(pageContent); break;
                case 'news': renderNewsPage(pageContent); break;
                case 'market': renderMarketPage(pageContent); break;
                case 'ai': renderAiAnalysisPage(pageContent); break;
                case 'mock': renderMockInvestmentPage(pageContent); break;
                case 'my': renderMyPage(pageContent); break;
                default: renderHomePage(pageContent);
            }
            renderHeader();
        }

        // --- Auth & Modal Pages ---
        function renderLoginPage(error = null) {
            appContainer.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-gray-50">
                <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                    <div class="flex justify-center items-center mb-6 gap-2">
                         <svg class="h-12 w-auto" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" fill="#3B82F6"/><path d="M12 2L17 4.5V13.5L12 11V2Z" fill="#60A5FA"/><path d="M12 11L7 13.5V20L12 22V11Z" fill="#2563EB"/></svg>
                         <span class="font-bold text-3xl text-gray-800">NextStep</span>
                    </div>
                    <form id="login-form">
                        ${error ? `<p class="text-red-500 text-sm mb-4 text-center">${error}</p>` : ''}
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium mb-1 text-gray-700">ì•„ì´ë””</label>
                            <input type="text" id="username" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="test">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium mb-1 text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="test1234">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">ë¡œê·¸ì¸</button>
                        <p class="text-center mt-4 text-sm text-gray-600">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" id="go-to-signup" class="text-blue-500 hover:underline">íšŒì›ê°€ì…</a></p>
                    </form>
                </div>
            </div>`;
        }

        function renderSignupPage(error = null) {
            appContainer.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-gray-50">
                <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">íšŒì›ê°€ì…</h2>
                    ${error ? `<p class="text-red-500 text-sm mb-4 text-center">${error}</p>` : ''}
                    <form id="signup-form">
                        <div class="mb-4"><label for="email" class="block text-sm font-medium mb-1 text-gray-700">ì´ë©”ì¼</label><input type="email" id="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <div class="mb-4"><label for="username" class="block text-sm font-medium mb-1 text-gray-700">ì•„ì´ë””</label><input type="text" id="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <div class="mb-6"><label for="password" class="block text-sm font-medium mb-1 text-gray-700">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">ê°€ì…í•˜ê¸°</button>
                        <p class="text-center mt-4 text-sm text-gray-600">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" id="go-to-login" class="text-blue-500 hover:underline">ë¡œê·¸ì¸</a></p>
                    </form>
                </div>
            </div>`;
        }
        
        function renderWelcomeModal() {
            modalContainer.innerHTML = `
            <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full transform transition-all scale-95 opacity-0">
                    <div class="text-center">
                        <svg class="h-12 w-auto mx-auto mb-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" fill="#3B82F6"/><path d="M12 2L17 4.5V13.5L12 11V2Z" fill="#60A5FA"/><path d="M12 11L7 13.5V20L12 22V11Z" fill="#2563EB"/></svg>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">NextStepì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                        <p class="text-gray-600 mb-6">AI ê¸°ìˆ ë¡œ ë‹¹ì‹ ì˜ ì„±ê³µì ì¸ íˆ¬ìë¥¼ ë•ëŠ” íŒŒíŠ¸ë„ˆì…ë‹ˆë‹¤.</p>
                    </div>
                    <div class="space-y-4 text-left mb-6">
                        <h3 class="font-semibold text-lg text-gray-800 border-b border-gray-200 pb-2">ì£¼ìš” ê¸°ëŠ¥</h3>
                        <p class="text-gray-700">ğŸ“ˆ <strong class="font-medium">AI ì˜ˆì¸¡ ë° ê³ ê¸‰ ì°¨íŠ¸:</strong> AI ì˜ˆì¸¡ê³¼ ê¸°ìˆ ì  ë³´ì¡°ì§€í‘œ(SMA, EMA)ë¡œ ì‹¬ì¸µ ë¶„ì„ì„ ê²½í—˜í•˜ì„¸ìš”.</p>
                        <p class="text-gray-700">â­ <strong class="font-medium">ë‚˜ë§Œì˜ í™ˆ í™”ë©´:</strong> ìì£¼ ì°¾ëŠ” ìœ„ì ¯ì„ í™ˆ í™”ë©´ì— ë°°ì¹˜í•˜ê³  ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë°”ê¿”ë³´ì„¸ìš”.</p>
                        <p class="text-gray-700">ğŸ“Š <strong class="font-medium">í•µì‹¬ ê²½ì œ ì§€í‘œ:</strong> ê¸ˆ, ìœ ê°€ ë“± ì‹œì¥ì˜ íë¦„ì„ ì½ëŠ” í•„ìˆ˜ ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="modal-tour-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">ë°”ë¡œ ì‹œì‘í•˜ê¸°</button>
                        <button id="modal-start-tutorial-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">ê°€ì´ë“œ ì‹œì‘í•˜ê¸°</button>
                    </div>
                    <div class="mt-6 text-center">
                        <label class="flex items-center justify-center text-sm text-gray-500 cursor-pointer"><input type="checkbox" id="modal-dont-show-again" class="mr-2"> ë‹¤ì‹œëŠ” ë³´ì§€ ì•Šê¸°</label>
                    </div>
                </div>
            </div>`;
            const modalContent = modalContainer.querySelector('#welcome-modal > div');
            setTimeout(() => { modalContent.style.transform = 'scale(1)'; modalContent.style.opacity = '1'; }, 50);
        }

        // --- Home Page ---
        async function renderHomePage(container) {
            const editButtonText = state.isWidgetEditMode ? 'ì™„ë£Œ' : 'ìœ„ì ¯ í¸ì§‘';
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold">í™ˆ</h1>
                    <div class="flex items-center gap-2">
                        ${state.isWidgetEditMode ? `<div class="tooltip-container"><span class="text-sm text-gray-500">ìœ„ì ¯ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë“œë˜ê·¸í•˜ë©´ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>` : ''}
                        <button id="widget-edit-toggle" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg btn-active">${editButtonText}</button>
                    </div>
                </div>
                <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                ${state.isWidgetEditMode ? renderAddWidgetPanel() : ''}`;
            renderWidgets();
        }
        
        function renderAddWidgetPanel() {
            const availableWidgets = [
                { type: 'indices', name: 'KOSPI ì§€ìˆ˜' }, { type: 'kospiChart', name: 'KOSPI ì°¨íŠ¸' },
                { type: 'gold', name: 'ê¸ˆ ì‹œì„¸' }, { type: 'oil', name: 'ìœ ê°€ ì •ë³´' },
                { type: 'topVolume', name: 'ì£¼ìš” ê±°ë˜ëŸ‰ ì¢…ëª©' }, { type: 'favorites', name: 'ë‚´ ì¦ê²¨ì°¾ê¸°' }
            ];
            const widgetButtons = availableWidgets.map(w => {
                const isAdded = state.widgets.some(sw => sw.type === w.type);
                return `<button data-widget-type="${w.type}" class="add-widget-btn text-left p-3 rounded-lg ${isAdded ? 'bg-gray-200 cursor-not-allowed text-gray-500' : 'bg-gray-100 hover:bg-blue-100'}" ${isAdded ? 'disabled' : ''}><p class="font-semibold">${w.name}</p></button>`
            }).join('');
            return `<div id="add-widget-panel" class="mt-8 bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-bold mb-4">ìœ„ì ¯ ì¶”ê°€í•˜ê¸°</h3><div class="grid grid-cols-2 sm:grid-cols-4 gap-4">${widgetButtons}</div></div>`;
        }

        async function renderWidgets() {
            const grid = document.getElementById('widget-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            for (const widgetConfig of state.widgets) {
                const widgetEl = document.createElement('div');
                widgetEl.id = widgetConfig.id;
                widgetEl.dataset.widgetType = widgetConfig.type;
                widgetEl.className = 'widget bg-white p-6 rounded-lg shadow-md relative transition-transform';
                if(state.isWidgetEditMode) {
                    widgetEl.draggable = true;
                    widgetEl.classList.add('cursor-move');
                }

                let content = '';
                if (state.isWidgetEditMode) content += `<button data-widget-id="${widgetConfig.id}" class="remove-widget-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-xs z-10">&times;</button>`;
                
                const indicesData = await mockApi.getIndices();
                let isClickable = false;
                switch (widgetConfig.type) {
                    case 'indices': content += renderIndicesWidget(indicesData); break;
                    case 'gold': content += renderGoldWidget(indicesData); break;
                    case 'oil': content += renderOilWidget(indicesData); break;
                    case 'kospiChart': widgetEl.classList.add('md:col-span-2', 'xl:col-span-2'); content += renderKospiChartWidget(); break;
                    case 'topVolume': isClickable = true; content += renderTopVolumeWidget(); break;
                    case 'favorites': isClickable = true; content += await renderFavoritesWidget(); break;
                }
                widgetEl.innerHTML = content;
                if(isClickable && !state.isWidgetEditMode) {
                    widgetEl.querySelectorAll('li[data-stock-code]').forEach(li => li.classList.add('cursor-pointer', 'hover:bg-gray-100', 'p-1', 'rounded'));
                }
                grid.appendChild(widgetEl);

                if(widgetConfig.type === 'kospiChart') updateKospiChart(7);
            }
        }
        
        function renderIndicesWidget(data) { return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">KOSPI ì§€ìˆ˜</h3><div class="space-y-3"><div class="flex justify-between items-center"><span class="font-medium text-gray-700">í˜„ì¬ ì§€ìˆ˜</span><div>${data.kospi.value.toFixed(2)} <span class="${data.kospi.change > 0 ? 'text-red-500':'text-blue-500'}">${data.kospi.change > 0 ? icons.arrowUp : icons.arrowDown} ${Math.abs(data.kospi.change).toFixed(2)}</span></div></div></div>`; }
        function renderGoldWidget(data) { return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">ê¸ˆ ì‹œì„¸</h3><div class="space-y-3"><div class="flex justify-between items-center"><span class="font-medium text-gray-700">1kg</span><div>${data.gold.price1kg.toLocaleString()}ì›</div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">100g</span><div>${data.gold.price100g.toLocaleString()}ì›</div></div></div>`; }
        function renderOilWidget(data) { return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">ìœ ê°€ ì •ë³´</h3><div class="space-y-3"><div class="flex justify-between items-center"><span class="font-medium text-gray-700">íœ˜ë°œìœ </span><div>${data.oil.gasoline.toLocaleString()}ì›</div></div><div class="flex justify-between items-center"><span class="font-medium text-gray-700">ê²½ìœ </span><div>${data.oil.diesel.toLocaleString()}ì›</div></div></div>`; }
        function renderKospiChartWidget(){ return `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">KOSPI ì§€ìˆ˜</h3><div class="flex space-x-1 text-xs"><button data-days="7" class="kospi-chart-period-btn px-2 py-1 rounded bg-blue-600 text-white">1ì£¼</button><button data-days="30" class="kospi-chart-period-btn px-2 py-1 rounded bg-gray-200">1ë‹¬</button><button data-days="365" class="kospi-chart-period-btn px-2 py-1 rounded bg-gray-200">1ë…„</button></div></div><div class="h-48"><canvas id="home-kospi-chart"></canvas></div>`; }
        function renderTopVolumeWidget() { const stocks = [...state.kospiStocks].sort((a,b)=>b.volume-a.volume).slice(0,5); const sign = (val) => val > 0 ? '+' : ''; const color = (val) => val > 0 ? 'text-red-500' : val < 0 ? 'text-blue-500' : 'text-gray-500'; return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">ì£¼ìš” ê±°ë˜ëŸ‰ ì¢…ëª©</h3><ul id="top-volume-list" class="space-y-2">${stocks.map(s => `<li data-stock-code="${s.code}"><div class="flex justify-between text-sm items-center"><span class="text-gray-800">${s.name}</span><div class="text-right"><span class="${color(s.change)}">${s.price.toLocaleString()}ì›</span><br/><span class="text-xs ${color(s.change)}">${sign(s.changeRate)}${s.changeRate.toFixed(2)}%</span></div></div></li>`).join('')}</ul>`; }
        async function renderFavoritesWidget() { const stocks = state.kospiStocks.filter(s => state.favorites.includes(s.code)); return `<h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">ë‚´ ì¦ê²¨ì°¾ê¸°</h3><ul class="divide-y">${stocks.length ? stocks.map(s => `<li data-stock-code="${s.code}" class="py-2"><div class="flex justify-between items-center"><span class="font-medium text-gray-800">${s.name}</span><span class="${s.change > 0 ? 'text-red-500' : 'text-blue-500'}">${s.price.toLocaleString()}ì›</span></div></li>`).join('') : '<li class="text-center text-gray-500 py-4">ì¦ê²¨ì°¾ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>'}</ul>`; }
        
        // --- Domestic Page & Modal ---
        function renderDomesticPage(container) { container.innerHTML = `<h1 class="text-2xl font-bold mb-1">êµ­ë‚´</h1><p class="text-gray-500 mb-6">KOSPI ì¢…ëª©ì˜ í˜„ì¬ ì‹œì„¸ë¥¼ í™•ì¸í•˜ê³ , ìƒì„¸ ì°¨íŠ¸ë¥¼ ë¶„ì„í•´ë³´ì„¸ìš”.</p><div class="mb-4"><input type="text" id="stock-search" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..." class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="p-4 w-12"></th><th class="p-4 font-semibold cursor-pointer sortable-header" data-sort-key="name">ì¢…ëª©ëª…</th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="price">í˜„ì¬ê°€</th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="change">ë“±ë½</th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="changeRate">ë“±ë½ë¥ </th><th class="p-4 font-semibold text-right cursor-pointer sortable-header" data-sort-key="volume">ê±°ë˜ëŸ‰</th></tr></thead><tbody id="stock-list-body"></tbody></table></div>`; renderStockList(state.kospiStocks); }
        function renderStockList(stocks) { const listBody=document.getElementById('stock-list-body'); if(!listBody)return; const sortedStocks=[...stocks].sort((a,b)=>{const{key,order}=state.domesticSort;if(a[key]<b[key])return order==='asc'?-1:1;if(a[key]>b[key])return order==='asc'?1:-1;return 0}); document.querySelectorAll('.sortable-header').forEach(h=>{h.innerHTML=h.innerHTML.replace(/ [â–²â–¼]$/,'');if(h.dataset.sortKey===state.domesticSort.key)h.innerHTML+=state.domesticSort.order==='asc'?' â–²':' â–¼'}); if(sortedStocks.length===0){listBody.innerHTML='<tr><td colspan="6" class="text-center p-8 text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return} listBody.innerHTML=sortedStocks.map(s=>{const isFavorite=state.isLoggedIn&&state.favorites.includes(s.code);const color=s.change>0?'text-red-500':s.change<0?'text-blue-500':'text-gray-500';const sign=s.change>0?'+':'';return`<tr class="stock-row hover:bg-gray-100 border-b last:border-b-0" data-stock-code="${s.code}"><td class="p-4"><button class="toggle-favorite-btn text-2xl z-10 relative" data-stock-code="${s.code}">${state.isLoggedIn?(isFavorite?icons.starFilled:icons.starOutline):icons.starOutline}</button></td><td class="p-4 font-medium"><div class="text-gray-900">${s.name}</div><div class="text-sm text-gray-400">${s.code}</div></td><td class="p-4 text-right font-semibold ${color}">${s.price.toLocaleString()}ì›</td><td class="p-4 text-right ${color}">${sign}${s.change.toLocaleString()}ì›</td><td class="p-4 text-right ${color}">${sign}${s.changeRate.toFixed(2)}%</td><td class="p-4 text-right text-sm text-gray-600">${s.volume.toLocaleString()}</td></tr>`}).join('')}

        async function renderStockDetailModal(stockCode) {
            const stock = state.kospiStocks.find(s => s.code === stockCode);
            const modalHTML = `
            <div id="stock-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-2xl p-6 max-w-4xl w-full transform transition-all scale-95 opacity-0">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                        <h2 class="text-xl font-bold">${stock.name} (${stock.code})</h2>
                        <button id="close-detail-modal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <div id="indicator-controls" class="flex items-center space-x-2 text-xs">
                             <button class="indicator-btn px-3 py-1 rounded-full" data-indicator="sma20">SMA(20)</button>
                             <button class="indicator-btn px-3 py-1 rounded-full" data-indicator="ema60">EMA(60)</button>
                             <div class="tooltip-container">
                                 ${icons.info}
                                 <span class="tooltip-text"><b>SMA (ë‹¨ìˆœì´ë™í‰ê· ):</b> íŠ¹ì • ê¸°ê°„ì˜ ì£¼ê°€ë¥¼ ì‚°ìˆ  í‰ê· í•œ ê°’ì…ë‹ˆë‹¤.<br/><b>EMA (ì§€ìˆ˜ì´ë™í‰ê· ):</b> ìµœê·¼ ì£¼ê°€ì— ë” ë†’ì€ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ëŠ” í‰ê· ê°’ì…ë‹ˆë‹¤.</span>
                             </div>
                        </div>
                        <div class="flex space-x-2 text-xs">
                            <button class="detail-chart-type-btn px-3 py-1 rounded-full" data-type="line">ì„  ì°¨íŠ¸</button>
                            <button class="detail-chart-type-btn px-3 py-1 rounded-full" data-type="candlestick">ìº”ë“¤ ì°¨íŠ¸</button>
                        </div>
                    </div>
                    <div class="h-72 mb-4"><canvas id="detail-chart"></canvas></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                        <div>
                            <h3 class="font-semibold mb-2">AI 1ì£¼ì¼ ì˜ˆì¸¡ (ì¢…ê°€)</h3>
                            <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-2">ë‚ ì§œ</th><th class="p-2 text-right">ì˜ˆìƒ ì¢…ê°€</th></tr></thead><tbody id="prediction-table"></tbody></table>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="mb-3 text-gray-700">ë” ìƒì„¸í•œ AI ë¶„ì„ê³¼ ê¸°ìˆ ì  ì§€í‘œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                            <button id="go-to-ai-page-from-modal" data-stock-code="${stockCode}" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">AI ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™</button>
                        </div>
                    </div>
                </div>
            </div>`;
            modalContainer.innerHTML = modalHTML;
            const modalContent = modalContainer.querySelector('#stock-detail-modal > div');
            setTimeout(() => { modalContent.style.transform = 'scale(1)'; modalContent.style.opacity = '1'; }, 50);

            const { historicalData, predictionData } = await mockApi.getStockChartData(stockCode);
            renderDetailChart(historicalData, stockCode);
            document.getElementById('prediction-table').innerHTML = predictionData.map(d => `<tr><td class="p-2">${formatKoreanDate(d.time)}</td><td class="p-2 text-right">${Math.round(d.value).toLocaleString()}ì›</td></tr>`).join('');
        }

        // --- Other Pages ---
        async function renderAiAnalysisPage(container) { 
            const selectedCode = state.currentParams?.stockCode;
            const favoriteStocks = state.kospiStocks.filter(s => state.favorites.includes(s.code));
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">AI ë¶„ì„</h1>
            <p class="text-gray-500 mb-6">NextStepì˜ AIê°€ ì˜ˆì¸¡í•œ ë¯¸ë˜ ì£¼ê°€ë¥¼ í†µí•´ íˆ¬ì ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì–´ë³´ì„¸ìš”.</p>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <label for="ai-stock-search" class="block text-sm font-medium mb-2">ë¶„ì„í•  ì¢…ëª© ê²€ìƒ‰:</label>
                        <input type="search" id="ai-stock-search" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..." class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="ai-search-results" class="mt-2 max-h-48 overflow-y-auto"></div>
                        ${favoriteStocks.length > 0 ? `
                        <div class="mt-4 pt-3 border-t">
                            <h4 class="text-sm font-semibold mb-2 text-gray-600">ì¦ê²¨ì°¾ê¸° ëª©ë¡:</h4>
                            <div id="ai-favorites-list" class="flex flex-wrap gap-2">
                                ${favoriteStocks.map(s => `<button class="ai-quick-select-btn text-xs px-3 py-1 rounded-full bg-gray-200 hover:bg-blue-200" data-stock-code="${s.code}">${s.name}</button>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                    <div id="ai-chart-area" class="bg-white p-6 rounded-lg shadow-md min-h-[400px]">
                        ${!selectedCode ? `<div class="flex items-center justify-center h-full text-gray-500">ë¶„ì„í•  ì¢…ëª©ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.</div>` : ''}
                    </div>
                </div>
                <div id="ai-recommendations-panel" class="bg-white p-6 rounded-lg shadow-md h-fit"></div>
            </div>`;
            if(selectedCode){
                updateAiChart(selectedCode);
            } 
            renderAiRecommendations();
        }
        
        async function renderAiRecommendations() { 
            const panel=document.getElementById('ai-recommendations-panel');
            if(!panel) return;
            const recommendations=await mockApi.getAiRecommendations();
            panel.innerHTML=`
            <h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2 flex items-center">AI ë§¤ë§¤ ì‹ í˜¸ 
                <div class="tooltip-container ml-2">
                    ${icons.info}
                    <span class="tooltip-text">GRU(Gated Recurrent Unit) AI ëª¨ë¸ì´ ê³¼ê±° 3ë…„ì¹˜ ì£¼ê°€ íŒ¨í„´ì„ í•™ìŠµí•˜ì—¬ í–¥í›„ 1ì£¼ì¼ê°„ì˜ ìƒìŠ¹/í•˜ë½ ì¶”ì„¸ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤. 'ë§¤ìˆ˜'ëŠ” ìƒìŠ¹ í™•ë¥ ì´, 'ë§¤ë„'ëŠ” í•˜ë½ í™•ë¥ ì´ ë†’ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</span>
                </div>
            </h3>
            <div class="space-y-4">${recommendations.map(r=>`
                <div class="p-3 rounded-lg bg-gray-50">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold">${r.name}</p>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${{'ë§¤ìˆ˜':'bg-red-100 text-red-800','ë§¤ë„':'bg-blue-100 text-blue-800','ë³´ìœ ':'bg-gray-100 text-gray-800'}[r.signal]}">${r.signal}</span>
                    </div>
                    <div class="text-sm mt-2 text-gray-600">
                        <p>ì‹ ë¢°ë„: ${(r.confidence*100).toFixed(0)}%</p>
                        <p>ëª©í‘œê°€: ${r.targetPrice.toLocaleString()}ì›</p>
                    </div>
                </div>`).join('')}
            </div>`;
        }
        
        async function renderNewsPage(container){ 
            const newsItems=await mockApi.getNews();
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">ë‰´ìŠ¤</h1>
            <p class="text-gray-500 mb-6">AIê°€ ìš”ì•½í•œ ìµœì‹  ê²½ì œ ë‰´ìŠ¤ì™€ ì‹œì¥ ê°ì„± ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <div class="space-y-6">${newsItems.map(item=>`
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-start mb-2">
                        <a href="${item.url}" target="_blank" class="text-lg font-bold hover:underline text-gray-900">${item.title}</a>
                        <span class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap ${item.sentiment==='positive'?'bg-red-100 text-red-800':'bg-blue-100 text-blue-800'}">${item.sentiment==='positive'?'ê¸ì •':'ë¶€ì •'}</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">${item.source} Â· ${item.time}</p>
                    <p class="text-gray-700 text-sm leading-relaxed">${item.summary}</p>
                </div>`).join('')}
            </div>`;
        }
        
        async function renderMarketPage(container){ 
            const indices = await mockApi.getIndices();
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">ì‹œì¥ ì§€í‘œ</h1>
            <p class="text-gray-500 mb-6">ì£¼ìš” ì‹œì¥ ì§€í‘œì˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-2">ê¸ˆ ì‹œì„¸</h3>
                    <div class="space-y-2 text-lg">
                        <p class="flex justify-between"><span>1kg</span> <strong>${indices.gold.price1kg.toLocaleString()}ì›</strong></p>
                        <p class="flex justify-between"><span>100g</span> <strong>${indices.gold.price100g.toLocaleString()}ì›</strong></p>
                    </div>
                    <div class="h-64 mt-4"><canvas id="gold-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-2">ìœ ê°€ ì •ë³´ (ë¦¬í„°ë‹¹)</h3>
                    <div class="space-y-2 text-lg">
                        <p class="flex justify-between"><span>íœ˜ë°œìœ </span> <strong>${indices.oil.gasoline.toLocaleString()}ì›</strong></p>
                        <p class="flex justify-between"><span>ê²½ìœ </span> <strong>${indices.oil.diesel.toLocaleString()}ì›</strong></p>
                        <p class="flex justify-between"><span>ë“±ìœ </span> <strong>${indices.oil.kerosene.toLocaleString()}ì›</strong></p>
                    </div>
                    <div class="h-64 mt-4"><canvas id="oil-chart"></canvas></div>
                </div>
            </div>`;
            renderMarketCharts();
        }
        
        function renderMockInvestmentPage(container) { 
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">ëª¨ì˜ íˆ¬ì</h1>
            <p class="text-gray-500 mb-6">AI ì˜ˆì¸¡ì„ ê¸°ë°˜ìœ¼ë¡œ ê°€ìƒ íˆ¬ìë¥¼ ê²½í—˜í•˜ê³ , íˆ¬ì ê²°ê³¼ë¥¼ ë¯¸ë¦¬ í™•ì¸í•´ë³´ì„¸ìš”.</p>
            <div class="bg-white p-6 rounded-lg shadow-md max-w-lg mx-auto">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <select id="mock-stock-select" class="p-2 border border-gray-300 rounded-lg col-span-2 sm:col-span-1">${state.kospiStocks.map(s=>`<option value="${s.code}">${s.name}</option>`).join('')}</select>
                    <input type="number" id="mock-quantity" placeholder="ìˆ˜ëŸ‰ (ì˜ˆ: 10)" min="1" class="p-2 border border-gray-300 rounded-lg col-span-2 sm:col-span-1">
                </div>
                <button id="mock-calculate-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">ê²°ê³¼ ê³„ì‚°í•˜ê¸°</button>
                <div id="mock-result" class="mt-6 pt-6 border-t">
                    <div class="flex items-center justify-center text-gray-500">
                        <p>ì¢…ëª©ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        <div class="tooltip-container ml-2">
                            ${icons.info}
                            <span class="tooltip-text">'í˜„ì¬ ê°€ì¹˜'ëŠ” í˜„ì¬ê°€ x ìˆ˜ëŸ‰, 'ì˜ˆìƒ ê°€ì¹˜'ëŠ” AIê°€ 7ì¼ í›„ë¡œ ì˜ˆì¸¡í•œ ì¢…ê°€ x ìˆ˜ëŸ‰ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. 'ì˜ˆìƒ ì†ìµ'ì€ ë‘ ê°€ì¹˜ì˜ ì°¨ì•¡ì…ë‹ˆë‹¤. ì´ëŠ” ì‹¤ì œ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderMyPage(container) {
            const favoriteStocks = state.kospiStocks.filter(stock => state.favorites.includes(stock.code));
            container.innerHTML=`
            <h1 class="text-2xl font-bold mb-1">MY</h1>
            <p class="text-gray-500 mb-6">ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê³  ì¦ê²¨ì°¾ê¸° ì¢…ëª©ì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">ê³„ì • ì •ë³´ ìˆ˜ì •</h3>
                    <form id="update-user-form">
                        <div class="space-y-4">
                            <p><strong class="text-gray-600">ì•„ì´ë””:</strong> ${state.currentUser.username}</p>
                            <p><strong class="text-gray-600">ì´ë©”ì¼:</strong> ${state.currentUser.email}</p>
                            <div><label class="text-sm font-medium">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="new-password" class="w-full mt-1 p-2 border border-gray-300 rounded" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"></div>
                            <div><label class="text-sm font-medium">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="confirm-password" class="w-full mt-1 p-2 border border-gray-300 rounded" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"></div>
                            <div class="flex justify-end items-center gap-3 pt-4">
                                <button type="button" id="delete-account-btn" class="px-4 py-2 text-sm font-medium text-red-600 bg-red-100 rounded-lg hover:bg-red-200">íšŒì› íƒˆí‡´</button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">ì •ë³´ ì €ì¥</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b border-gray-200 pb-2">ì¦ê²¨ì°¾ê¸° ëª©ë¡ (${favoriteStocks.length})</h3>
                    <ul id="my-favorites-list" class="divide-y max-h-96 overflow-y-auto">
                        ${favoriteStocks.length > 0 ? favoriteStocks.map(stock => `
                            <li class="flex justify-between items-center py-3">
                                <div><p class="font-medium">${stock.name}</p><p class="text-sm text-gray-400">${stock.code}</p></div>
                                <button data-stock-code="${stock.code}" class="my-remove-favorite-btn px-3 py-1 text-xs font-medium text-red-600 bg-red-100 rounded-full hover:bg-red-200">ì‚­ì œ</button>
                            </li>`).join('') : '<li class="text-center text-gray-500 py-8">ì¦ê²¨ì°¾ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>'}
                    </ul>
                </div>
            </div>`;
        }

        // --- CHART RENDERING FUNCTIONS ---
        function renderDetailChart(historicalData, stockCode) {
            const ctx = document.getElementById('detail-chart')?.getContext('2d');
            if(!ctx) return;
            if(state.charts.detail) state.charts.detail.destroy();

            document.querySelectorAll('.detail-chart-type-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.type === state.detailChartType);
                btn.classList.toggle('text-white', btn.dataset.type === state.detailChartType);
                btn.classList.toggle('bg-gray-200', btn.dataset.type !== state.detailChartType);
            });
            document.querySelectorAll('.indicator-btn').forEach(btn => {
                const indicator = btn.dataset.indicator;
                btn.classList.toggle('bg-blue-600', state.detailChartIndicators[indicator]);
                btn.classList.toggle('text-white', state.detailChartIndicators[indicator]);
                btn.classList.toggle('bg-gray-200', !state.detailChartIndicators[indicator]);
            });

            const chartType = state.detailChartType;
            let datasets = [];

            if (chartType === 'line') {
                datasets.push({
                    label: 'ì¢…ê°€',
                    data: historicalData.map(d => ({x: d.t, y: d.c})),
                    borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0,
                });
            } else { // candlestick
                datasets.push({
                    label: stockCode,
                    data: historicalData.map(d => ({x: d.t, o: d.o, h: d.h, l: d.l, c: d.c})),
                    color: { up: '#ef4444', down: '#3b82f6', unchanged: '#9ca3af' }
                });
            }
            // Add indicators
            if (state.detailChartIndicators.sma20) {
                const smaData = calculateSMA(historicalData, 20);
                datasets.push({ type: 'line', label: 'SMA(20)', data: smaData.map(d => ({x: d.t, y: d.y})), borderColor: '#f97316', borderWidth: 1.5, pointRadius: 0 });
            }
            if (state.detailChartIndicators.ema60) {
                const emaData = calculateEMA(historicalData, 60);
                datasets.push({ type: 'line', label: 'EMA(60)', data: emaData.map(d => ({x: d.t, y: d.y})), borderColor: '#8b5cf6', borderWidth: 1.5, pointRadius: 0 });
            }

            state.charts.detail = new Chart(ctx, {
                type: chartType === 'line' ? 'line' : 'candlestick',
                data: { datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month' } } }, plugins: { legend: { display: true, position: 'bottom', align: 'start' } } }
            });
        }
        async function updateKospiChart(days) { const data = await mockApi.getKospiHistory(days); const ctx = document.getElementById('home-kospi-chart')?.getContext('2d'); if(!ctx) return; document.querySelectorAll('.kospi-chart-period-btn').forEach(btn => { const isSelected = parseInt(btn.dataset.days) === days; btn.classList.toggle('bg-blue-600', isSelected); btn.classList.toggle('text-white', isSelected); btn.classList.toggle('bg-gray-200', !isSelected); }); if(state.charts.kospiHome) state.charts.kospiHome.destroy(); state.charts.kospiHome = new Chart(ctx, { type: 'line', data: { datasets: [{ label: 'KOSPI', data: data.map(d => ({x: d.time, y: d.value})), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, pointRadius: 0, tension: 0.1, fill: true, }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: days > 31 ? 'month' : 'day' }, display: false, grid: { color: 'rgba(200, 200, 200, 0.1)' } }, y: { display: false, grid: { color: 'rgba(200, 200, 200, 0.1)' } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } } }); }
        async function updateAiChart(stockCode) { 
            const chartArea = document.getElementById('ai-chart-area');
            if (!chartArea) return;
            chartArea.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold">${state.kospiStocks.find(s => s.code === stockCode)?.name || ''} ë¶„ì„</h3>
                    <div class="flex space-x-1 text-xs">
                        <button class="ai-chart-type-btn px-3 py-1 rounded-full" data-type="line">ì„  ì°¨íŠ¸</button>
                        <button class="ai-chart-type-btn px-3 py-1 rounded-full" data-type="candlestick">ìº”ë“¤ ì°¨íŠ¸</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="ai-chart"></canvas></div>`;

            document.querySelectorAll('.ai-chart-type-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.type === state.aiChartType);
                btn.classList.toggle('text-white', btn.dataset.type === state.aiChartType);
                btn.classList.toggle('bg-gray-200', btn.dataset.type !== state.aiChartType);
            });

            const { historicalData, predictionData } = await mockApi.getStockChartData(stockCode);
            if (state.charts.ai) state.charts.ai.destroy();
            
            const lastHistoricalPoint = historicalData.length > 0 ? historicalData[historicalData.length - 1] : {t: Date.now(), c: 50000};
            const predictionArea = [{ x: lastHistoricalPoint.t, y: lastHistoricalPoint.c }, ...predictionData.map(d => ({ x: d.time, y: d.value }))];
            const allValues = [...historicalData.map(d => d.h), ...historicalData.map(d => d.l), ...predictionData.map(d => d.value)];
            const yMin = Math.min(...allValues) * 0.98;
            const yMax = Math.max(...allValues) * 1.02;

            let historicalDataset;
            if(state.aiChartType === 'line') {
                historicalDataset = { type: 'line', label: 'ê³¼ê±° ì¢…ê°€', data: historicalData.map(d => ({x: d.t, y: d.c})), borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0 };
            } else {
                historicalDataset = { label: 'ê³¼ê±° ì£¼ê°€', data: historicalData.map(d => ({ x: d.t, o: d.o, h: d.h, l: d.l, c: d.c })), color: { up: '#ef4444', down: '#3b82f6', unchanged: '#9ca3af' } };
            }
            
            state.charts.ai = new Chart(document.getElementById('ai-chart').getContext('2d'), { 
                type: state.aiChartType === 'line' ? 'line' : 'candlestick',
                data: { datasets: [ historicalDataset, { type: 'line', label: 'AI ì˜ˆì¸¡', data: predictionArea, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', borderWidth: 2, pointRadius: 0, tension: 0.1, fill: true, }] }, 
                options: { responsive: true, maintainAspectRatio: false, layout: { padding: { bottom: 20 } }, scales: { x: { type: 'time', time: { unit: 'month' }, grid: { color: 'rgba(200, 200, 200, 0.1)' } }, y: { grid: { color: 'rgba(200, 200, 200, 0.1)' }, min: yMin, max: yMax } }, plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } } } 
            }); 
        }
        async function renderMarketCharts() { const goldData = await mockApi.getKospiHistory(365); const oilData = await mockApi.getKospiHistory(365); const goldCtx = document.getElementById('gold-chart')?.getContext('2d'); const oilCtx = document.getElementById('oil-chart')?.getContext('2d'); if(!goldCtx || !oilCtx) return; const gridColor = 'rgba(0, 0, 0, 0.1)'; const fontColor = '#1F2937'; const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month' }, ticks:{color: fontColor}, grid:{color: gridColor} }, y: { ticks: { callback: value => `${(value/1000000).toFixed(0)}ë°±ë§Œ`, color: fontColor }, grid:{color: gridColor} } }, plugins: { legend: { display: false } } }; state.charts.gold = new Chart(goldCtx, { type: 'line', data: { datasets: [{ label: 'ê¸ˆ ì‹œì„¸', data: goldData.map(d => ({x: d.time, y: d.value * 30000})), borderColor: '#f59e0b', borderWidth: 2, pointRadius: 0 }] }, options: chartOptions }); state.charts.oil = new Chart(oilCtx, { type: 'line', data: { datasets: [{ label: 'WTI ìœ ê°€', data: oilData.map(d => ({x: d.time, y: d.value * 60})), borderColor: '#4f46e5', borderWidth: 2, pointRadius: 0 }] }, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, ticks: { callback: value => `${value.toLocaleString()}ì›`}} }}}); }
        
        // ===================================================================================
        // TUTORIAL FUNCTIONS
        // ===================================================================================
        function startTutorial() {
            if (state.tutorial.seen) return;
            state.tutorial.active = true;
            state.tutorial.step = 0;
            runTutorialStep();
        }

        function advanceTutorial() {
            state.tutorial.step++;
            runTutorialStep();
        }

        function endTutorial(dontShowAgain = false) {
            state.tutorial.active = false;
            tutorialContainer.innerHTML = '';
            if (dontShowAgain) {
                state.tutorial.seen = true;
                localStorage.setItem('nextstep-tutorial-seen', 'true');
            }
        }

        async function runTutorialStep() {
            if (!state.tutorial.active) return;

            const steps = [
                // Step 0: Start and go to Domestic Page
                {
                    run: () => {
                        navigate('domestic');
                        setTimeout(() => renderTutorialOverlay(
                            `.nav-link[data-page='domestic']`,
                            'NextStep ê°€ì´ë“œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ë¨¼ì €, <strong>êµ­ë‚´ ì£¼ì‹</strong> ë©”ë‰´ë¥¼ í†µí•´ ì‹œì¥ í˜„í™©ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.',
                            { next: true, position: 'bottom' }
                        ), 500);
                    }
                },
                // Step 1: Click a stock
                {
                    run: () => renderTutorialOverlay(
                        `tr[data-stock-code='${state.tutorial.stockCode}']`,
                        `ì´ê³³ì—ì„œ KOSPI ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <strong>'${state.tutorial.stockName}'</strong>ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.`,
                        { waitFor: 'click', on: `tr[data-stock-code='${state.tutorial.stockCode}']`, position: 'bottom' }
                    )
                },
                // Step 2: Explain chart toggle
                {
                    run: () => setTimeout(() => renderTutorialOverlay(
                        `.detail-chart-type-btn[data-type='candlestick']`,
                        'ì°¨íŠ¸ ìš°ì¸¡ ìƒë‹¨ì˜ ë²„íŠ¼ìœ¼ë¡œ <strong>ì„  ì°¨íŠ¸</strong>ì™€ <strong>ìº”ë“¤ ì°¨íŠ¸</strong>ë¥¼ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                        { next: true, position: 'bottom' }
                    ), 500)
                },
                // Step 3: Explain and click indicator
                {
                    run: () => renderTutorialOverlay(
                        `#indicator-controls`,
                        `ì°¨íŠ¸ ì¢Œì¸¡ì˜ ë²„íŠ¼ìœ¼ë¡œ <strong>ë³´ì¡°ì§€í‘œ</strong>ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <strong>SMA(20)</strong>ì„ í´ë¦­í•˜ì—¬ 20ì¼ ì´ë™í‰ê· ì„ ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.`,
                        { waitFor: 'click', on: `.indicator-btn[data-indicator='sma20']`, position: 'bottom' }
                    )
                },
                // Step 4: Click go to AI page
                {
                    run: () => renderTutorialOverlay(
                        `#go-to-ai-page-from-modal`,
                        `ì˜í•˜ì…¨ì–´ìš”! ì´ì œ ì´ ì¢…ëª©ì— ëŒ€í•œ <strong>AI ë¶„ì„</strong> ê²°ê³¼ë¥¼ í™•ì¸í•˜ëŸ¬ ê°€ë³´ê² ìŠµë‹ˆë‹¤. ì´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`,
                        { waitFor: 'click', on: `#go-to-ai-page-from-modal`, position: 'top' }
                    )
                },
                 // Step 5: Explain AI chart
                {
                    run: () => {
                         closeModal();
                         navigate('ai', { stockCode: state.tutorial.stockCode });
                         setTimeout(() => renderTutorialOverlay(
                            `#ai-chart`,
                            `ì´ê³³ì€ AI ë¶„ì„ í˜ì´ì§€ì…ë‹ˆë‹¤. ì£¼í™©ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ì˜ì—­ì´ AIê°€ ì˜ˆì¸¡í•œ <strong>í–¥í›„ 7ì¼ê°„ì˜ ì£¼ê°€</strong>ì…ë‹ˆë‹¤.`,
                            { next: true, position: 'bottom' }
                        ), 500);
                    }
                },
                // Step 6: Explain AI recommendations
                {
                    run: () => renderTutorialOverlay(
                        `#ai-recommendations-panel`,
                        `ìš°ì¸¡ì—ì„œëŠ” AIê°€ ë¶„ì„í•œ <strong>ë§¤ë§¤ ì‹ í˜¸</strong>ì™€ ì‹ ë¢°ë„, ëª©í‘œê°€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
                        { next: true, position: 'left' }
                    )
                },
                // Step 7: Final Step
                {
                    run: () => renderTutorialOverlay(
                        `a[data-page='home']`,
                        `íŠœí† ë¦¬ì–¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! NextStepì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ììœ ë¡­ê²Œ íƒìƒ‰í•´ë³´ì„¸ìš”. ë¡œê³ ë¥¼ í´ë¦­í•˜ë©´ ì–¸ì œë“ ì§€ í™ˆìœ¼ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
                        { finish: true, position: 'bottom' }
                    )
                }
            ];

            if (state.tutorial.step < steps.length) {
                steps[state.tutorial.step].run();
            } else {
                endTutorial();
            }
        }

        function renderTutorialOverlay(targetSelector, text, options) {
            const target = document.querySelector(targetSelector);
            if (!target) { console.warn("Tutorial target not found:", targetSelector); advanceTutorial(); return; }

            const rect = target.getBoundingClientRect();
            
            const popoverHTML = `
                <div id="tutorial-overlay"></div>
                <div id="tutorial-spotlight" style="top:${rect.top-4}px; left:${rect.left-4}px; width:${rect.width+8}px; height:${rect.height+8}px;"></div>
                <div id="tutorial-popover">
                    <div class="tutorial-arrow"></div>
                    <div class="text-sm mb-4">${text}</div>
                    <div class="flex justify-between items-center">
                        <button id="tutorial-skip-btn" class="text-xs text-gray-500 hover:underline">íŠœí† ë¦¬ì–¼ ê±´ë„ˆë›°ê¸°</button>
                        <div>
                        ${options.next ? `<button id="tutorial-next-btn" class="bg-blue-600 text-white px-4 py-1 rounded-md text-sm">ë‹¤ìŒ</button>` : ''}
                        ${options.finish ? `<button id="tutorial-finish-btn" class="bg-blue-600 text-white px-4 py-1 rounded-md text-sm">ì™„ë£Œ</button>` : ''}
                        </div>
                    </div>
                </div>`;
            tutorialContainer.innerHTML = popoverHTML;
            
            const popover = document.getElementById('tutorial-popover');
            const popoverRect = popover.getBoundingClientRect();
            const arrow = popover.querySelector('.tutorial-arrow');

            // Position popover
            if (options.position === 'bottom') {
                popover.style.top = `${rect.bottom + 15}px`;
                popover.style.left = `${rect.left + rect.width / 2 - popoverRect.width / 2}px`;
                arrow.classList.add('up');
            } else if (options.position === 'top') {
                popover.style.top = `${rect.top - popoverRect.height - 15}px`;
                popover.style.left = `${rect.left + rect.width / 2 - popoverRect.width / 2}px`;
                arrow.classList.add('down');
            } else if (options.position === 'left') {
                popover.style.top = `${rect.top + rect.height/2 - popoverRect.height/2}px`;
                popover.style.left = `${rect.left - popoverRect.width - 20}px`;
            } else { // default bottom
                popover.style.top = `${rect.bottom + 15}px`;
                popover.style.left = `${rect.left + rect.width / 2 - popoverRect.width / 2}px`;
                arrow.classList.add('up');
            }
            // Boundary checks
            const finalPopoverRect = popover.getBoundingClientRect();
            if(finalPopoverRect.left < 10) popover.style.left = '10px';
            if(finalPopoverRect.right > window.innerWidth - 10) popover.style.left = `${window.innerWidth - popoverRect.width - 10}px`;


            if (options.waitFor) {
                const actionHandler = (e) => {
                    if (e.target.closest(options.on)) {
                        document.body.removeEventListener(options.waitFor, actionHandler, true);
                        advanceTutorial();
                    }
                };
                document.body.addEventListener(options.waitFor, actionHandler, true);
            }
        }


        // ===================================================================================
        // EVENT HANDLERS & LOGIC
        // ===================================================================================
        function setupEventListeners() {
            document.body.addEventListener('click', handleClicks);
            document.body.addEventListener('submit', handleSubmits);
            document.body.addEventListener('change', handleChanges);
            document.body.addEventListener('input', handleInputs);
            document.body.addEventListener('dragstart', handleDragStart);
            document.body.addEventListener('dragover', handleDragOver);
            document.body.addEventListener('dragleave', handleDragLeave);
            document.body.addEventListener('drop', handleDrop);
            document.body.addEventListener('dragend', handleDragEnd);
        }

        function handleClicks(e) {
            // Tutorial handlers first, to prevent other actions
            if (state.tutorial.active) {
                if(e.target.closest('#tutorial-next-btn')) { e.stopPropagation(); advanceTutorial(); return; }
                if(e.target.closest('#tutorial-finish-btn')) { e.stopPropagation(); endTutorial(true); return; }
                if(e.target.closest('#tutorial-skip-btn')) { e.stopPropagation(); endTutorial(true); return; }
            }
            
            const navLink = e.target.closest('.nav-link, a[data-page]');
            if (navLink) { e.preventDefault(); navigate(navLink.dataset.page); }
            if (e.target.closest('#go-to-signup')) { e.preventDefault(); renderSignupPage(); }
            if (e.target.closest('#go-to-login')) { e.preventDefault(); renderLoginPage(); }
            if (e.target.closest('#logout-btn')) handleLogout();
            if (e.target.closest('#modal-tour-btn')) { closeModal(); }
            if (e.target.closest('#modal-start-tutorial-btn')) { closeModal(); startTutorial(); }
            if (e.target.closest('#close-detail-modal')) closeModal();
            if (e.target.closest('#go-to-ai-page-from-modal')) { navigate('ai', { stockCode: e.target.closest('#go-to-ai-page-from-modal').dataset.stockCode }); closeModal(); }
            const stockRow = e.target.closest('.stock-row');
            if (stockRow && !e.target.closest('.toggle-favorite-btn')) { renderStockDetailModal(stockRow.dataset.stockCode); }
            if (e.target.closest('.toggle-favorite-btn')) { e.stopPropagation(); toggleFavorite(e.target.closest('.toggle-favorite-btn').dataset.stockCode); }
            if (e.target.closest('.my-remove-favorite-btn')) toggleFavorite(e.target.dataset.stockCode);
            if (e.target.closest('.sortable-header')) handleSort(e.target.closest('.sortable-header').dataset.sortKey);
            if (e.target.closest('#mock-calculate-btn')) handleMockCalculation();
            if (e.target.closest('#delete-account-btn')) handleDeleteAccount();
            if (e.target.closest('#widget-edit-toggle')) toggleWidgetEditMode();
            if (e.target.closest('.remove-widget-btn')) removeWidget(e.target.dataset.widgetId);
            if (e.target.closest('.add-widget-btn')) addWidget(e.target.dataset.widgetType);
            const widgetStock = e.target.closest('.widget li[data-stock-code]');
            if(widgetStock && !state.isWidgetEditMode) renderStockDetailModal(widgetStock.dataset.stockCode);
            if(e.target.closest('.kospi-chart-period-btn')) updateKospiChart(parseInt(e.target.closest('.kospi-chart-period-btn').dataset.days));
            const aiQuickSelectBtn = e.target.closest('.ai-quick-select-btn');
            if (aiQuickSelectBtn) {
                const code = aiQuickSelectBtn.dataset.stockCode;
                state.currentParams = { stockCode: code };
                updateAiChart(code);
                document.getElementById('ai-stock-search').value = state.kospiStocks.find(s=>s.code===code).name;
                document.getElementById('ai-search-results').innerHTML = '';
            }
            const aiSearchResult = e.target.closest('.ai-search-result-item');
             if (aiSearchResult) {
                const code = aiSearchResult.dataset.stockCode;
                state.currentParams = { stockCode: code };
                updateAiChart(code);
                document.getElementById('ai-stock-search').value = aiSearchResult.textContent.split('(')[0].trim();
                document.getElementById('ai-search-results').innerHTML = '';
            }
            if(e.target.closest('.detail-chart-type-btn')) {
                state.detailChartType = e.target.closest('.detail-chart-type-btn').dataset.type;
                const stockCode = document.getElementById('go-to-ai-page-from-modal').dataset.stockCode;
                mockApi.getStockChartData(stockCode).then(({historicalData}) => renderDetailChart(historicalData, stockCode));
            }
             if(e.target.closest('.indicator-btn')) {
                const indicator = e.target.closest('.indicator-btn').dataset.indicator;
                state.detailChartIndicators[indicator] = !state.detailChartIndicators[indicator];
                const stockCode = document.getElementById('go-to-ai-page-from-modal').dataset.stockCode;
                mockApi.getStockChartData(stockCode).then(({historicalData}) => renderDetailChart(historicalData, stockCode));
            }
            if(e.target.closest('.ai-chart-type-btn')) {
                state.aiChartType = e.target.closest('.ai-chart-type-btn').dataset.type;
                if(state.currentParams?.stockCode) updateAiChart(state.currentParams.stockCode);
            }
        }

        function handleSubmits(e) {
            e.preventDefault();
            if (e.target.id === 'login-form') handleLogin(e.target);
            if (e.target.id === 'signup-form') handleSignup(e.target);
            if (e.target.id === 'update-user-form') handleUpdateUser(e.target);
        }

        function handleChanges(e) {
            if (e.target.id === 'modal-dont-show-again') localStorage.setItem('nextstep-hide-welcome', 'true');
        }

        function handleInputs(e) {
            if (e.target.id === 'stock-search') {
                const searchTerm = e.target.value.toLowerCase();
                renderStockList(state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm)));
            }
            if (e.target.id === 'ai-stock-search') {
                const searchTerm = e.target.value.toLowerCase();
                const resultsContainer = document.getElementById('ai-search-results');
                if(!searchTerm) {
                    resultsContainer.innerHTML = ''; return;
                }
                const filtered = state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm)).slice(0, 5);
                resultsContainer.innerHTML = filtered.length > 0 ? 
                    `<ul class="bg-white border rounded-md shadow-lg">${filtered.map(s => `
                        <li class="ai-search-result-item p-2 hover:bg-gray-100 cursor-pointer" data-stock-code="${s.code}">
                            ${s.name} (${s.code})
                        </li>`).join('')}</ul>` : 
                    `<div class="p-2 text-sm text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }
        
        function handleDragStart(e) { if(e.target.classList.contains('widget')) { state.draggedWidgetId = e.target.id; e.target.classList.add('dragging'); } }
        function handleDragOver(e) { if(state.draggedWidgetId) { e.preventDefault(); const target = e.target.closest('.widget'); if(target && target.id !== state.draggedWidgetId) target.classList.add('drag-over'); } }
        function handleDragLeave(e) { const target = e.target.closest('.widget'); if(target) target.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault();
            const targetWidget = e.target.closest('.widget');
            if (!targetWidget || targetWidget.id === state.draggedWidgetId) return;
            const draggedIndex = state.widgets.findIndex(w => w.id === state.draggedWidgetId);
            const targetIndex = state.widgets.findIndex(w => w.id === targetWidget.id);
            const [draggedItem] = state.widgets.splice(draggedIndex, 1);
            state.widgets.splice(targetIndex, 0, draggedItem);
            localStorage.setItem('nextstep-widgets', JSON.stringify(state.widgets));
            renderWidgets();
        }
        function handleDragEnd(e) { state.draggedWidgetId = null; document.querySelectorAll('.widget').forEach(w => w.classList.remove('dragging', 'drag-over')); }
        
        // --- Core Logic Functions ---
        function navigate(page, params = null) { state.currentPage = page; state.currentParams = params; renderPage(); }
        async function handleLogin(form) {
            const username = form.username.value;
            const password = form.password.value;
            try {
                const { accessToken, user } = await mockApi.login(username, password);
                state.isLoggedIn = true;
                state.currentUser = user;
                localStorage.setItem('nextstep-token', accessToken);
                localStorage.setItem('nextstep-user', JSON.stringify(user));
                initializeApp();
            } catch (err) { renderLoginPage(err.message); }
        }
        async function handleSignup(form) {
            try {
                await mockApi.signup(form.email.value, form.username.value, form.password.value);
                alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                renderLoginPage();
            } catch (err) { renderSignupPage(err.message); }
        }
        function handleLogout() {
            state.isLoggedIn = false;
            state.currentUser = null;
            localStorage.removeItem('nextstep-token');
            localStorage.removeItem('nextstep-user');
            sessionStorage.removeItem('welcome-shown');
            renderApp();
        }
        async function handleUpdateUser(form) {
            const newPassword = form.elements['new-password'].value;
            const confirmPassword = form.elements['confirm-password'].value;
            if (!newPassword) { alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if (newPassword !== confirmPassword) { alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
            try {
                const result = await mockApi.updateUser(state.currentUser.username, newPassword);
                alert(result.message);
                form.reset();
            } catch(e) { alert(e.message); }
        }
        async function handleDeleteAccount() {
            if (confirm("ì •ë§ë¡œ íšŒì› íƒˆí‡´ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.")) {
                try {
                    await mockApi.deleteUser(state.currentUser.username);
                    alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    handleLogout();
                } catch(e) { alert(e.message); }
            }
        }
        async function handleMockCalculation() {
            const code = document.getElementById('mock-stock-select').value;
            const quantity = parseInt(document.getElementById('mock-quantity').value, 10);
            const resultDiv = document.getElementById('mock-result');
            if (isNaN(quantity) || quantity <= 0) { resultDiv.innerHTML = `<p class="text-red-500 text-center">ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.</p>`; return; }
            
            const stock = state.kospiStocks.find(s => s.code === code);
            const { predictionData } = await mockApi.getStockChartData(code);
            const currentValue = stock.price * quantity;
            const futureValue = predictionData[6].value * quantity;
            const pnl = futureValue - currentValue;
            const pnlColor = pnl > 0 ? 'text-red-500' : 'text-blue-500';

            resultDiv.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between"><span>í˜„ì¬ ê°€ì¹˜:</span> <strong>${Math.round(currentValue).toLocaleString()}ì›</strong></div>
                    <div class="flex justify-between"><span>1ì£¼ì¼ í›„ ì˜ˆìƒ ê°€ì¹˜:</span> <strong>${Math.round(futureValue).toLocaleString()}ì›</strong></div>
                    <div class="flex justify-between font-bold text-lg ${pnlColor}"><span>ì˜ˆìƒ ì†ìµ:</span> <strong>${pnl > 0 ? '+' : ''}${Math.round(pnl).toLocaleString()}ì›</strong></div>
                </div>`;
        }
        function toggleFavorite(stockCode) { const index = state.favorites.indexOf(stockCode); if (index > -1) state.favorites.splice(index, 1); else state.favorites.push(stockCode); localStorage.setItem('nextstep-favorites', JSON.stringify(state.favorites)); if (state.currentPage === 'domestic') { const searchTerm = document.getElementById('stock-search')?.value.toLowerCase() || ''; const filteredStocks = state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm)); renderStockList(filteredStocks); } else if (state.currentPage === 'my') { renderMyPage(document.querySelector('.page-content')); } else if (state.currentPage === 'home') { renderHomePage(document.querySelector('.page-content')); } else if (state.currentPage === 'ai') { renderAiAnalysisPage(document.querySelector('.page-content')); } }
        function handleSort(key){ if (state.domesticSort.key === key) { state.domesticSort.order = state.domesticSort.order === 'asc' ? 'desc' : 'asc'; } else { state.domesticSort.key = key; state.domesticSort.order = 'desc'; } const searchTerm = document.getElementById('stock-search')?.value.toLowerCase() || ''; const filteredStocks = state.kospiStocks.filter(s => s.name.toLowerCase().includes(searchTerm) || s.code.includes(searchTerm)); renderStockList(filteredStocks); }
        function toggleWidgetEditMode() { state.isWidgetEditMode = !state.isWidgetEditMode; renderHomePage(document.querySelector('.page-content')); }
        function removeWidget(widgetId) { state.widgets = state.widgets.filter(w => w.id !== widgetId); localStorage.setItem('nextstep-widgets', JSON.stringify(state.widgets)); renderHomePage(document.querySelector('.page-content')); }
        function addWidget(widgetType) { if (!state.widgets.some(w => w.type === widgetType)) { state.widgets.push({ id: `widget-${Date.now()}`, type: widgetType }); localStorage.setItem('nextstep-widgets', JSON.stringify(state.widgets)); renderHomePage(document.querySelector('.page-content')); } }
        function closeModal() { modalContainer.innerHTML = ''; }
        
        // ===================================================================================
        // INITIALIZATION
        // ===================================================================================
        async function initializeApp() {
            setupEventListeners();
            
            if (state.isLoggedIn) {
                state.kospiStocks = await mockApi.getKospiStocks();
                // Add tutorial stock to the list for demonstration
                state.kospiStocks.unshift({ code: state.tutorial.stockCode, name: state.tutorial.stockName, price: 52300, change: 800, changeRate: 1.55, volume: 1234567 });
            }
            
            renderApp();
        }

        initializeApp();
    </script>
</body>
</html>